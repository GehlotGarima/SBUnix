cscope 15 $HOME/arpitsingh/check/garima_2_june/sys -q 0000000670 0000065049
	@elf.c

1 
	~<sys/ñf.h
>

2 
	~<sys/sbunix.h
>

3 
	~<sys/èrfs.h
>

4 
	~<sys/°rög.h
>

5 
	~<sys/¥o˚ss.h
>

6 
	~<sys/vmmu.h
>

7 
	~<sys/pm≠.h
>

8 
	~<sys/èrfs.h
>

11 * 
	$gë_bö¨y
(*
fûíame
)

13 
posix_hódî_u°¨
 *
èrfs_°¨t
 = (posix_hódî_u°¨ *)&
_bö¨y_èrfs_°¨t
;

16 if(
fûíame
 =
NULL
)

17  
NULL
;

19 
uöt32_t
 *
íd
 = (uöt32_à*)
èrfs_°¨t
;

20 *
íd
++ || *end++ || *end){

21 if(
	`°rcmp
(
èrfs_°¨t
->
«me
,
fûíame
) != 0) {

23 
j
, 
k
=0;

24 
uöt64_t
 
ãmp
 = 0;

26 
j
 = 10;j >= 0; --j)

27 
ãmp
 =Åem∞+ (
èrfs_°¨t
->
size
[
j
]-48Ë* 
	`powî
(8,
k
++);

29 if(
ãmp
%512 != 0){

30 
ãmp
 = (temp/512)*512;

31 
ãmp
 += 512;

33 
èrfs_°¨t
 = (
posix_hódî_u°¨
 *)((
uöt64_t
)tarfs_start +

34 
ãmp
 + (
posix_hódî_u°¨
));

35 
íd
 = (
uöt32_t
 *)
èrfs_°¨t
;

38  (*)
èrfs_°¨t
;

41  
NULL
;

42 
	}
}

44 
	$lﬂd_exe
(
èsk_°ru˘
 *
èsk
, *
exe_°¨t
)

46 
mm_°ru˘
 *
mm
 = 
èsk
->mm;

49 
ñfHódî
 *
ehdr
 = (ñfHódî *)
exe_°¨t
;

52 
¥ogHódî
 *
phdr
 = (¥ogHódî *)((
uöt64_t
)
ehdr
 +Éhdr->
e_phoff
);

54 
cou¡
 = 0;

57 
èsk
->
rù
 = 
ehdr
->
e_íåy
;

58 
èsk
->
mm
->
mm≠
 = 
NULL
;

60 ; 
cou¡
 < 
ehdr
->
e_phnum
; count++) {

63 if(
phdr
->
p_ty≥
 == 1) {

65 
vma_°ru˘
 *
vma
 = (vma_°ru˘ *)
	`kmÆloc
();

67 if(
mm
->
mm≠
 =
NULL
) {

68 
mm
->
mm≠
 = 
vma
;

70 
mm
->
cuºít
->
√xt
 = 
vma
;

73 
mm
->
cuºít
 = 
vma
;

74 
vma
->
mm
 = mm;

76 
vma
->
°¨t
 = 
phdr
->
p_vaddr
;

77 
vma
->
íd
 = 
phdr
->
p_vaddr
 +Öhdr->
p_memsz
;

80 
uöt64_t
 
size
 = (((
vma
->
íd
/0x1000)*0x1000 + 0x1000)-((vma->
°¨t
/0x1000)*0x1000));

81 
uöt64_t
 
ôr
 = 
size
/0x1000;

82 
uöt64_t
 
°¨t
 = (
phdr
->
p_vaddr
/0x1000)*0x1000;

83 
ôr
) {

84 
uöt64_t
 
∑ge
 = (uöt64_t)
	`Æloˇã_∑ge
();

85 
	`m≠_¥o˚ss
(
°¨t
, 
∑ge
);

86 
ôr
--;

87 
°¨t
 += 0x1000;

90 
vma
->
Êags
 = 
phdr
->
p_Êags
;

91 
vma
->
fûe
 = 
NULL
;

92 
vma
->
√xt
 = 
NULL
;

93 
vma
->
ty≥
 = 
NOTYPE
;

95 if((
phdr
->
p_Êags
 =(
PERM_R
 | 
PERM_X
))

96 || (
phdr
->
p_Êags
 =(
PERM_R
 | 
PERM_W
))){

98 
èsk
->
mm
->
°¨t_code
 = 
phdr
->
p_vaddr
;

99 
èsk
->
mm
->
íd_code
 = 
phdr
->
p_vaddr
 +Öhdr->
p_memsz
;

100 
vma
->
fûe
 = (fûê*)
	`kmÆloc
();

101 
vma
->
fûe
->
°¨t
 = (
uöt64_t
)
ehdr
;

102 
vma
->
fûe
->
pgoff
 = 
phdr
->
p_off£t
;

103 
vma
->
fûe
->
size
 = 
phdr
->
p_fûesz
;

105 
	`mem˝y
((*)
vma
->
°¨t
, (*)((
uöt64_t
)
ehdr
 + 
phdr
->
p_off£t
),Öhdr->
p_fûesz
);

106 if(
phdr
->
p_Êags
 =(
PERM_R
 | 
PERM_X
)) {

107 
vma
->
fûe
->
bss_size
 = 0;

108 
vma
->
ty≥
 = 
TEXT
;

110 
vma
->
fûe
->
bss_size
 = 
phdr
->
p_memsz
 -Öhdr->
p_fûesz
;

111 
vma
->
ty≥
 = 
DATA
;

117 
phdr
++;

121 
vma_°ru˘
 *
vma_hóp
 = (vma_°ru˘ *)
	`kmÆloc
();

122 if(
mm
->
mm≠
 =
NULL
)

123 
mm
->
mm≠
 = 
vma_hóp
;

125 
mm
->
cuºít
->
√xt
 = 
vma_hóp
;

127 
mm
->
cuºít
 = 
vma_hóp
;

128 
vma_hóp
->
mm
 = mm;

134 
vma_hóp
->
°¨t
 = 
HEAP_START
;

135 
mm
->
brk
 = 
HEAP_START
;

136 
vma_hóp
->
íd
 = 
HEAP_START
 + 
PAGE_SIZE
;

137 
vma_hóp
->
Êags
 = (
PERM_R
 | 
PERM_W
);

138 
vma_hóp
->
ty≥
 = 
HEAP
;

139 
vma_hóp
->
fûe
 = 
NULL
;

140 
vma_hóp
->
√xt
 = 
NULL
;

141 
	`gë_phy_addr
(
HEAP_START
);

144 
vma_°ru˘
 *
vma_°ack
 = (vma_°ru˘ *)
	`kmÆloc
();

146 if(
mm
->
mm≠
 =
NULL
) {

147 
mm
->
mm≠
 = 
vma_°ack
;

149 
mm
->
cuºít
->
√xt
 = 
vma_°ack
;

151 
mm
->
cuºít
 = 
vma_°ack
;

153 
uöt64_t
 *
°ack
 = (uöt64_à*)
	`gë_phy_addr
(
USER_STACK_TOP
);

154 
vma_°ack
->
°¨t
 = (
uöt64_t
)
°ack
 + 
PAGE_SIZE
;

155 
vma_°ack
->
íd
 = (
uöt64_t
)
°ack
;

156 
vma_°ack
->
Êags
 = (
PERM_R
 | 
PERM_W
);

157 
vma_°ack
->
ty≥
 = 
STACK
;

158 
vma_°ack
->
fûe
 = 
NULL
;

159 
vma_°ack
->
√xt
 = 
NULL
;

161 
èsk
->
r•
 = (
uöt64_t
)((uöt64_t)
°ack
 + 4096 - 16);

164 
	}
}

	@gdt.c

1 
	~<sys/gdt.h
>

5 
	#MAX_GDT
 32

	)

7 
	#GDT_CS
 (0x00180000000000Ë

	)

8 
	#GDT_DS
 (0x00100000000000Ë

	)

10 
	#C
 (0x00040000000000Ë

	)

11 
	#DPL0
 (0x00000000000000Ë

	)

12 
	#DPL1
 (0x00200000000000Ë

	)

13 
	#DPL2
 (0x00400000000000Ë

	)

14 
	#DPL3
 (0x00600000000000Ë

	)

15 
	#P
 (0x00800000000000Ë

	)

16 
	#L
 (0x20000000000000Ë

	)

17 
	#D
 (0x40000000000000Ë

	)

18 
	#W
 (0x00020000000000Ë

	)

20 
	ssys_£gmít_des¸ùt‹
 {

21 
uöt64_t
 
	msd_lﬁimô
:16;

22 
uöt64_t
 
	msd_loba£
:24;

23 
uöt64_t
 
	msd_ty≥
:5;

24 
uöt64_t
 
	msd_d∂
:2;

25 
uöt64_t
 
	msd_p
:1;

26 
uöt64_t
 
	msd_hûimô
:4;

27 
uöt64_t
 
	msd_xx1
:3;

28 
uöt64_t
 
	msd_gøn
:1;

29 
uöt64_t
 
	msd_hiba£
:40;

30 
uöt64_t
 
	msd_xx2
:8;

31 
uöt64_t
 
	msd_zîo
:5;

32 
uöt64_t
 
	msd_xx3
:19;

33 }
__©åibuã__
((
∑cked
));

35 
uöt64_t
 
	ggdt
[
MAX_GDT
] = {

37 
GDT_CS
 | 
P
 | 
DPL0
 | 
L
,

38 
GDT_DS
 | 
P
 | 
W
 | 
DPL0
,

39 
GDT_CS
 | 
P
 | 
DPL3
 | 
L
,

40 
GDT_DS
 | 
P
 | 
W
 | 
DPL3
,

44 
	sgdå_t
 {

45 
uöt16_t
 
	msize
;

46 
uöt64_t
 
	maddr
;

47 }
__©åibuã__
((
∑cked
));

49 
gdå_t
 
	ggdå
 = {

50 (
gdt
),

51 (
uöt64_t
)
gdt
,

54 
_x86_64_asm_lgdt
(
gdå_t
* 
gdå
, 
uöt64_t
 
cs_idx
, uöt64_à
ds_idx
);

56 
	$ªlﬂd_gdt
() {

57 
	`_x86_64_asm_lgdt
(&
gdå
, 8, 16);

58 
	}
}

60 
	$£tup_tss
() {

61 
sys_£gmít_des¸ùt‹
* 
sd
 = (sys_£gmít_des¸ùt‹*)&
gdt
[5];

62 
sd
->
sd_lﬁimô
 = (
tss_t
)-1;

63 
sd
->
sd_loba£
 = ((
uöt64_t
)&
tss
);

64 
sd
->
sd_ty≥
 = 9;

65 
sd
->
sd_d∂
 = 0;

66 
sd
->
sd_p
 = 1;

67 
sd
->
sd_hûimô
 = 0;

68 
sd
->
sd_gøn
 = 0;

69 
sd
->
sd_hiba£
 = ((
uöt64_t
)&
tss
) >> 24;

70 
	}
}

	@io.c

8 
	~<sys/öãºu±s.h
>

11 
	$outb
(
uöt16_t
 
p‹t
, uöt16_à
vÆ
)

13 
__asm__
 vﬁ©ûê("outb %%Æ, %%dx"::"d" (
p‹t
), "a" (
vÆ
));

15 
	}
}

18 
	$öb
(
uöt16_t
 
p‹t
) {

19 
ªt
;

21 
__asm__
 vﬁ©ûê("öb %%dx,%%Æ":"˜"(
ªt
):"d"(
p‹t
));

23  
ªt
;

24 
	}
}

	@isr.c

8 
	~<sys/defs.h
>

9 
	~<sys/öãºu±s.h
>

10 
	~<sys/sbunix.h
>

11 
	~<sys/sysˇŒ.h
>

12 
	~<sys/°rög.h
>

13 
	~<sys/¥o˚ss.h
>

14 
	~<sys/vmmu.h
>

15 
	~<sys/ñf.h
>

17 
i§0
();

18 
i§1
();

19 
i§2
();

20 
i§3
();

21 
i§4
();

22 
i§5
();

23 
i§6
();

24 
i§7
();

25 
i§8
();

26 
i§9
();

27 
i§10
();

28 
i§11
();

29 
i§12
();

30 
i§13
();

31 
i§14
();

32 
i§15
();

33 
i§16
();

34 
i§17
();

35 
i§18
();

36 
i§19
();

37 
i§20
();

38 
i§21
();

39 
i§22
();

40 
i§23
();

41 
i§24
();

42 
i§25
();

43 
i§26
();

44 
i§27
();

45 
i§28
();

46 
i§29
();

47 
i§30
();

48 
i§31
();

49 
i§_timî
();

50 
i§_keybﬂrd
();

51 
i§_sysˇŒ
();

53 
èsk_°ru˘
 *
cuºít
;

59 
idt_íåy
 
	gidt
[256];

60 
idt_±r
 
	gidç
;

66 
	$idt_£t_g©e
(
num
, 
ba£
, 
£l
,

67 
Êags
, 
d∂
)

70 
idt
[
num
].
off£t_low
 = (
ba£
) & 0xFFFF;

71 
idt
[
num
].
£À˘‹
 = 
£l
 & 0xFFFF;

72 
idt
[
num
].
i°
 = 0;

73 
idt
[
num
].
ª£rved0
 = 0;

74 
idt
[
num
].
ty≥
 = 
Êags
;

75 
idt
[
num
].
zîo
 = 0;

76 
idt
[
num
].
d∂
 = dpl;

77 
idt
[
num
].
p
 = 1;

78 
idt
[
num
].
off£t_mid
 = (
ba£
 >> 16) & 0xFFFF;

79 
idt
[
num
].
off£t_high
 = (
ba£
 >> 32) & 0xFFFFFFFF;

82 
	}
}

85 
	$ªlﬂd_idt
()

88 
idç
.
limô
 = ( (
idt_íåy
) * 256) - 1;

89 
idç
.
ba£
 = (
uöt64_t
)&
idt
;

92 
	`mem£t
(&
idt
, 0, (
idt_íåy
) * 256);

94 
	`öô_i§
();

96 
__asm__
 
	`__vﬁ©ûe__
 ( "lidt (%0)\n"

98 :"r"(&
idç
)

104 
	}
}

107 
	$ªöô_PIC
()

111 
	`outb
(0x20, 0x11);

112 
	`outb
(0xA0, 0x11);

115 
	`outb
(0x21, 0x20);

116 
	`outb
(0xA1, 0x28);

119 
	`outb
(0x21, 0x04);

120 
	`outb
(0xA1, 0x02);

123 
	`outb
(0x21, 0x01);

124 
	`outb
(0xA1, 0x01);

127 
	`outb
(0x21, 0x0);

128 
	`outb
(0xA1, 0x0);

130 
	}
}

132 
	$öô_i§
()

134 
	`idt_£t_g©e
(0, ((
uöt64_t
)
i§0
),0x08, 0xe, 0);

135 
	`idt_£t_g©e
(1, ((
uöt64_t
)
i§1
),0x08, 0xe, 0);

136 
	`idt_£t_g©e
(2, ((
uöt64_t
)
i§2
),0x08, 0xe, 0);

137 
	`idt_£t_g©e
(3, ((
uöt64_t
)
i§3
),0x08, 0xe, 0);

138 
	`idt_£t_g©e
(4, ((
uöt64_t
)
i§4
),0x08, 0xe, 0);

139 
	`idt_£t_g©e
(5, ((
uöt64_t
)
i§5
),0x08, 0xe, 0);

140 
	`idt_£t_g©e
(6, ((
uöt64_t
)
i§6
),0x08, 0xe, 0);

141 
	`idt_£t_g©e
(7, ((
uöt64_t
)
i§7
),0x08, 0xe, 0);

142 
	`idt_£t_g©e
(8, ((
uöt64_t
)
i§8
),0x08, 0xe, 0);

143 
	`idt_£t_g©e
(9, ((
uöt64_t
)
i§9
),0x08, 0xe, 0);

144 
	`idt_£t_g©e
(10, ((
uöt64_t
)
i§10
),0x08, 0xe, 0);

145 
	`idt_£t_g©e
(11, ((
uöt64_t
)
i§11
),0x08, 0xe, 0);

146 
	`idt_£t_g©e
(12, ((
uöt64_t
)
i§12
),0x08, 0xe, 0);

147 
	`idt_£t_g©e
(13, ((
uöt64_t
)
i§13
),0x08, 0xe, 0);

148 
	`idt_£t_g©e
(14, ((
uöt64_t
)
i§14
),0x08, 0xe, 0);

149 
	`idt_£t_g©e
(15, ((
uöt64_t
)
i§15
),0x08, 0xe, 0);

150 
	`idt_£t_g©e
(16, ((
uöt64_t
)
i§16
),0x08, 0xe, 0);

151 
	`idt_£t_g©e
(17, ((
uöt64_t
)
i§17
),0x08, 0xe, 0);

152 
	`idt_£t_g©e
(18, ((
uöt64_t
)
i§18
),0x08, 0xe, 0);

153 
	`idt_£t_g©e
(19, ((
uöt64_t
)
i§19
),0x08, 0xe, 0);

154 
	`idt_£t_g©e
(20, ((
uöt64_t
)
i§20
),0x08, 0xe, 0);

155 
	`idt_£t_g©e
(21, ((
uöt64_t
)
i§21
),0x08, 0xe, 0);

156 
	`idt_£t_g©e
(22, ((
uöt64_t
)
i§22
),0x08, 0xe, 0);

157 
	`idt_£t_g©e
(23, ((
uöt64_t
)
i§23
),0x08, 0xe, 0);

158 
	`idt_£t_g©e
(24, ((
uöt64_t
)
i§24
),0x08, 0xe, 0);

159 
	`idt_£t_g©e
(25, ((
uöt64_t
)
i§25
),0x08, 0xe, 0);

160 
	`idt_£t_g©e
(26, ((
uöt64_t
)
i§26
),0x08, 0xe, 0);

161 
	`idt_£t_g©e
(27, ((
uöt64_t
)
i§27
),0x08, 0xe, 0);

162 
	`idt_£t_g©e
(28, ((
uöt64_t
)
i§28
),0x08, 0xe, 0);

163 
	`idt_£t_g©e
(29, ((
uöt64_t
)
i§29
),0x08, 0xe, 0);

164 
	`idt_£t_g©e
(30, ((
uöt64_t
)
i§30
),0x08, 0xe, 0);

165 
	`idt_£t_g©e
(31, ((
uöt64_t
)
i§31
),0x08, 0xe, 0);

167 
	`idt_£t_g©e
(32, ((
uöt64_t
)
i§_timî
),0x08, 0xe, 0);

168 
	`idt_£t_g©e
(33, ((
uöt64_t
)
i§_keybﬂrd
),0x08, 0xe, 0);

170 
	`idt_£t_g©e
(128, ((
uöt64_t
)
i§_sysˇŒ
),0x08, 0xe, 3);

172 
	`ªöô_PIC
();

173 
	}
}

175 
	$∑geÁu…_h™dÀr
(
i§_ªgs
 *
ªg
)

177 vﬁ©ûê
uöt64_t
 
Áu…Addr
;

178 
__asm
 vﬁ©ûe("mov %%¸2, %0" : "Ù" (
Áu…Addr
));

181 
uöt64_t
 
îr
 = 
ªg
->
îr_code
 & 0xF;

183 
vma_°ru˘
 *
vma
 = 
cuºít
->
mm
->
mm≠
;

186 if((
îr
 & 
PF_P
Ë&& (î∏& 
PF_W
)) {

188 
uöt64_t
 
±e_íåy
 = 
	`∑
(
Áu…Addr
);

189 if(
±e_íåy
 & 
PTE_COW
) {

190 
uöt64_t
 
ãmp_vaddr
 = (uöt64_t)
	`kmÆloc
();

191 
uöt64_t
 
∑ddr
 = 
	`∑
(
	`gë_addªss
(&
ãmp_vaddr
));

193 
	`mem˝y
((*)
ãmp_vaddr
, (*)(
Áu…Addr
&(0xffffffffffffffffUL<<12)), 4096);

194 
	`m≠_¥o˚ss
(
Áu…Addr
&(0xffffffffffffffffUL<<12), 
∑ddr
);

196 
±e_íåy
 = (±e_íåy & ~0xfff)| 
PTE_P
 | 
PTE_W
 | 
PTE_U
;

201 
vma
) {

204 if(
vma
->
ty≥
 =
STACK
 && 
Áu…Addr
 <vma->
íd
 &&

205 (
vma
->
°¨t
 - vma->
íd
 - 
PAGE_SIZE
Ë<
STACK_LIMIT
){

207 
uöt64_t
 *
°ack
 = (uöt64_à*)
	`gë_phy_addr
(
vma
->
íd
 - 
PAGE_SIZE
);

208 
vma
->
íd
 = (
uöt64_t
)
°ack
;

213 if(
vma
->
ty≥
 =
HEAP
 && 
Áu…Addr
 >vma->
°¨t
 &&

214 
Áu…Addr
 <
vma
->
íd
) {

215 
uöt64_t
 *
hóp
 = (uöt64_à*)
	`gë_phy_addr
(
vma
->
íd
);

216 
vma
->
íd
 = ((
uöt64_t
)
hóp
) + 0x1000;

219 
vma
 = vma->
√xt
;

221 
	}
}

223 
	$gpf
(
i§_ªgs
 *
ªg
)

225 
	`¥ötf
("General Protection Fault\n");

227 
uöt64_t
 
Áu…Addr
;

228 
uöt64_t
 
¸3
;

230 
__asm
 vﬁ©ûe("mov %%¸2, %0" : "Ù" (
Áu…Addr
));

231 
__asm
 vﬁ©ûe("mov %%¸3, %0" : "Ù" (
¸3
));

233 
	`¥ötf
("\¿gp‡¸3 %p\n", 
¸3
);

234 
	`¥ötf
("\¿gp‡¸2 %p\n", 
Áu…Addr
);

237 
	}
}

239 
	$öå_6
(
i§_ªgs
 *
ªg
)

242 
	`¥ötf
("Illegal Opcode\n");

243 
	}
}

246 
	$execuã_öãºu±
(
i§_ªgs
 *
ªg
)

251 i‡(
ªg
->
öt_no
 == 32){

252 
	`tick_timî
(
ªg
);

260 if(
ªg
->
öt_no
 == 33) {

261 
	`keybﬂrd_i§
();

264 if(
ªg
->
öt_no
 == 128) {

265 
	`sysˇŒ_h™dÀr
(
ªg
);

273 i‡(
ªg
->
öt_no
 >= 40)

275 
	`outb
(0xA0, 0x20);

278 if(
ªg
->
öt_no
 == 14) {

279 
	`∑geÁu…_h™dÀr
(
ªg
);

282 if(
ªg
->
öt_no
 == 13) {

283 
	`gpf
(
ªg
);

289 
	`outb
(0x20, 0x20);

290 
	}
}

293 
	$öãºu±_h™dÀr
(
i§_ªgs
 *
ªg
)

300 
	`execuã_öãºu±
(
ªg
);

301 
	}
}

	@keyboard.c

8 
	~<sys/öãºu±s.h
>

9 
	~<sys/kbsˇncodes.h
>

10 
	~<sys/sbunix.h
>

11 
	~<sys/°rög.h
>

13 
	gshi·
;

14 vﬁ©ûê
	gsˇn_buf
[1024];

15 vﬁ©ûê
	gsˇn_Àn
 = 0;

16 vﬁ©ûê
	gsˇn_Êag
 = 0;

18 
	$sˇnf_°dö
(*
addr
,
cou¡
) {

20 
sˇn_Êag
 = 1;

21 
__asm__
 
	`__vﬁ©ûe__
("sti;");

24 
sˇn_Àn
 = 0;

26  
sˇn_Êag
 == 1);

27 i‡(
cou¡
 < 
sˇn_Àn
)

28 
sˇn_Àn
 = 
cou¡
;

30 
	`mem˝y
((*)
addr
,(*)
sˇn_buf
,
sˇn_Àn
);

31 
sˇn_Àn
 >=0){

32 
sˇn_buf
[
sˇn_Àn
]= '\0';

33 --
sˇn_Àn
;

37 
Àn
 = 
sˇn_Àn
;

38 
sˇn_Àn
 = 0;

39  
Àn
;

41 
	}
}

43 
	$öãΩªt_sˇncode
(
uöt16_t
 
sˇn_code
)

45 
öãΩªãd_ch¨
 = '\0';

46 
esc_ödex
;

49 if(
sˇn_code
 =
SPACE
)

50 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

53 if(
sˇn_code
 =
ENTER
){

54 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

55 
esc_ödex
 = 0;

56 i‡(
sˇn_Êag
 == 1) {

57 
sˇn_Êag
 =0;

59 
	`¥öt_√wlöe
();

63 if(
sˇn_code
 =
BCKSPC
){

64 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

65 
esc_ödex
 = 1;

66 i‡(
sˇn_Êag
 =1 && 
sˇn_Àn
 == 0){

69 
	`¥öt_back•a˚
();

71 i‡((
sˇn_Êag
 =1Ë&& (
sˇn_Àn
 > 0))

73 
sˇn_buf
[--
sˇn_Àn
] = ' ';

80 if(
sˇn_code
 =
ESC
){

81 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

82 
esc_ödex
 = 3;

86 if(
sˇn_code
 =
TAB
) {

87 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

88 
esc_ödex
 = 2;

89 
	`¥öt_èb
();

92 
	`¥öt_löe
(43, 24," ");

95 if((
sˇn_code
 >
CHR_Q
 && sˇn_codê<
CHR_P
) ||

96 (
sˇn_code
 >
CHR_A
 && sˇn_codê<
CHR_L
) ||

97 (
sˇn_code
 >
CHR_Z
 && sˇn_codê<
CHR_M
)) {

99 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
] + (
shi·
>0 ? (-32) : 0);

100 
	`¥ötf
("%c", 
öãΩªãd_ch¨
);

101 
	`¥öt_löe
(43, 24, "%c", 
öãΩªãd_ch¨
);

102 i‡(
sˇn_Êag
 == 1)

104 
sˇn_buf
[
sˇn_Àn
++] = 
öãΩªãd_ch¨
;

111 if(
shi·
) {

112 if(
sˇn_code
 >
SCHR_1
 && sˇn_codê<
SCHR_0
)

113 
öãΩªãd_ch¨
 = "!@#$%^&*()"[
sˇn_code
-
SCHR_1
];

115 if(
sˇn_code
 >
CURL_BRACK_OPEN
 && sˇn_codê<
CURL_BRACK_CLOSE
)

116 
öãΩªãd_ch¨
 = "{}"[
sˇn_code
-
CURL_BRACK_OPEN
];

118 if(
sˇn_code
 >
COMMA_OPENDLM
 && sˇn_codê<
FRWDSLASH_QUESTION
)

119 
öãΩªãd_ch¨
 = "<>?"[
sˇn_code
-
COMMA_OPENDLM
];

121 if(
sˇn_code
 >
COLON_SEMICLN
 && sˇn_codê<
TILDE
)

122 
öãΩªãd_ch¨
 = ":\"~"[
sˇn_code
-
COLON_SEMICLN
];

124 if(
sˇn_code
 >
UNDERSCORE_HYPHEN
 && sˇn_codê<
EQUALS_PLUS
)

125 
öãΩªãd_ch¨
 = "_+"[
sˇn_code
-
UNDERSCORE_HYPHEN
];

127 if(
sˇn_code
 =
OR_BCKSLASH
)

128 
öãΩªãd_ch¨
 = '|';

130 
öãΩªãd_ch¨
 = 
kbdus
[
sˇn_code
];

134 if((
öãΩªãd_ch¨
 == 8) || (interpreted_char == 9) ||

135 (
öãΩªãd_ch¨
 == 10) || (interpreted_char == 27)) {

136 
	`¥öt_löe
(43, 24, "%s", 
esˇ≥_°rög
[
esc_ödex
]);

141 if(
öãΩªãd_ch¨
) {

142 i‡(
sˇn_Êag
 == 1)

144 
sˇn_buf
[
sˇn_Àn
++] = 
öãΩªãd_ch¨
;

146 
	`¥ötf
("%c", 
öãΩªãd_ch¨
);

147 
	`¥öt_löe
(43, 24, "%c", 
öãΩªãd_ch¨
);

150 
	}
}

153 
	$keybﬂrd_i§
() {

155 
uöt16_t
 
sˇncode
 = 0;

158 
uöt16_t
 
°©us
 = 
	`öb
(0x64);

165 if(
°©us
 & 0x01) {

168 if((
sˇncode
 = 
	`öb
(0x60)) < 0) {

171 if(
sˇncode
 & 0x80) {

173 
sˇncode
 = (
shi·
 & (1<<6) ? scancode : scancode & 0x7F);

174 
shi·
 = 0;

179 if(
sˇncode
 =
LEFT_SHIFT
 || sˇncodê=
RIGHT_SHIFT
) {

180 
shi·
 = 1;

189 
	`öãΩªt_sˇncode
(
sˇncode
);

193 
	}
}

	@main.c

1 
	~<sys/sbunix.h
>

2 
	~<sys/gdt.h
>

3 
	~<sys/èrfs.h
>

4 
	~<sys/öãºu±s.h
>

5 
	~<sys/pm≠.h
>

6 
	~<sys/vmmu.h
>

7 
	~<sys/¥o˚ss.h
>

9 
	#INITIAL_STACK_SIZE
 4096

	)

11 
	g°ack
[
INITIAL_STACK_SIZE
];

12 
uöt32_t
* 
	glﬂdî_°ack
;

13 
kînmem
, 
physba£
;

14 
tss_t
 
	gtss
;

15 
èsk_°ru˘
 *
cuºít
;

18 
	$°¨t
(
uöt32_t
* 
moduÀp
, * 
physba£
, * 
phys‰ì
)

21 
	ssm≠_t
 {

22 
uöt64_t
 
ba£
, 
Àngth
;

23 
uöt32_t
 
ty≥
;

24 }
	`__©åibuã__
((
∑cked
)Ë*
sm≠
;

25 
moduÀp
[0] != 0x9001) modulep += modulep[1]+2;

26 
sm≠
 = (
sm≠_t
*)(
moduÀp
+2); smap < (smap_t*)((*)modulep+modulep[1]+2*4); ++smap) {

27 i‡(
sm≠
->
ty≥
 =1 && sm≠->
Àngth
 != 0) {

29 
	`öô_phy_mem
((
uöt64_t
)
physba£
, (uöt64_t)
phys‰ì
, 
sm≠
->
ba£
, sm≠->ba£ + sm≠->
Àngth
);

35 
	`˛ór_c⁄sﬁe
();

37 
	`£tup_∑ge_èbÀs
((
uöt64_t
)
physba£
);

38 
	`£t_idítôy_∑gög
();

39 
	`lﬂd_CR3
();

41 
	`öô_èrfs
();

42 
	`öô_¥o˚ss_m≠
();

43 
	`¸óã_öô_¥o˚ss
();

46 
èsk_°ru˘
 *
öô_¥oc
 = 
	`¸óã_u£r_¥o˚ss
("bin/sbush");

47 if(
öô_¥oc
 =
NULL
)

50 
	`swôch_to_rög3
(
öô_¥oc
);

52 
	`ö°Æl_timî
();

53 
	`keybﬂrd_i§
();

56 
__asm__
 volatile("sti");

59 
	}
}

68 
	$boŸ
()

72 
	`__asm__
(

75 :"=g"(
lﬂdî_°ack
)

76 :"r"(&
°ack
[
INITIAL_STACK_SIZE
])

78 
	`ªlﬂd_gdt
();

79 
	`ªlﬂd_idt
();

80 
	`£tup_tss
();

81 
	`°¨t
(

82 (
uöt32_t
*)((*)(
uöt64_t
)
lﬂdî_°ack
[3] + (uöt64_t)&
kînmem
 - (uöt64_t)&
physba£
),

83 &
physba£
,

84 (*)(
uöt64_t
)
lﬂdî_°ack
[4]

89 
	}
}

	@pmap.c

9 
	~<sys/sbunix.h
>

10 
	~<sys/defs.h
>

11 
	~<sys/pm≠.h
>

12 
	~<sys/vmmu.h
>

13 
	~<sys/°rög.h
>

16 
uöt64_t
 
	gk_phys‰ì
;

17 
uöt64_t
 
	gmax_phys
;

19 
uöt64_t
 *
	gmm≠
;

23 
	$mm≠_£t
(
uöt64_t
 
bô
) {

25 
mm≠
[
bô
/64] |= (1ull << (bit%64));

26 
	}
}

30 
	$mm≠_un£t
(
uöt64_t
 
bô
) {

31 
mm≠
[
bô
/64] &= ~(1ull << (bit%64));

32 
	}
}

36 
	$öô_phy_mem
(

37 
uöt64_t
 
physba£
,

38 
uöt64_t
 
phys‰ì
,

39 
uöt64_t
 
ba£
,

40 
uöt64_t
 
limô
)

42 
k_phys‰ì
 = 
phys‰ì
;

43 
max_phys
 = 
limô
;

44 
low_add
 = 0;

45 
°¨t
 = 0, 
íd
 = 0;

47 
uöt64_t
 
ßve_kîn‰ì
 = 
k_phys‰ì
;

48 
mm≠
 = (
uöt64_t
 *Ë
k_phys‰ì
;

50 
	`mem£t
((*)
mm≠
, 0, 
MMAP_SIZE
);

51 
ßve_kîn‰ì
 +(
uöt64_t
)(
MMAP_SIZE
 * 64/8);

52 
k_phys‰ì
 = 
ßve_kîn‰ì
;

54 
°¨t
 = 
ba£
/
PAGE_SIZE
;

55 
íd
 = 
limô
/
PAGE_SIZE
;

57 
	`mm≠_un£t
(0);

58 
	`mm≠_un£t
(1);

59 
°¨t
++ <
íd
) {

64 if((
°¨t
 * 
PAGE_SIZE
Ë<
k_phys‰ì
 &&

65 (
°¨t
 * 
PAGE_SIZE
Ë>
physba£
);

67 
	`mm≠_£t
(
°¨t
);

71 
°¨t
 = 0; 
low_add
 < 0x100000;Üow_add += 0x1000) {

72 
°¨t
++;

73 
	`mm≠_un£t
(
°¨t
);

76 
	}
}

78 
	$gë_fú°_‰ì∑ge
() {

80 
uöt64_t
 
i
=0;

82 
i
=0; i < 
MMAP_SIZE
; i++) {

83 
uöt64_t
 
j
;

84 
j
 = 0; j < 64; j++) {

85 
uöt64_t
 
bô
 = 1uŒ << 
j
;

87 if(
mm≠
[
i
] & 
bô
)

88  
i
*64 + 
j
;

93 
	}
}

95 * 
	$Æloˇã_∑ge
(){

97 
uöt64_t
 
∑ge_addr
;

98 
ödex
 = 
	`gë_fú°_‰ì∑ge
();

100 if(
ödex
 == -1)

101  
NULL
;

103 
	`mm≠_un£t
(
ödex
);

104 
∑ge_addr
 = 
ödex
 * 
PAGE_SIZE
;

106  (*)
∑ge_addr
;

107 
	}
}

109 
	$dóŒoˇã_∑ge
(*
addr
) {

111 
uöt64_t
 
∑ge_addr
 = (uöt64_t)
addr
;

112 
ödex
 = 
∑ge_addr
/
PAGE_SIZE
;

113 
	`mm≠_£t
(
ödex
);

114 
	}
}

116 
uöt64_t
 
	$gë_phys‰ì
() {

117  
k_phys‰ì
;

118 
	}
}

120 
uöt64_t
 
	$gë_maxphys‰ì
() {

121  
max_phys
;

122 
	}
}

	@print.c

8 
	~<sys/sbunix.h
>

9 
	~<sys/gdt.h
>

10 
	~<sys/èrfs.h
>

11 
	~<°d¨g.h
>

12 
	~<sys/öãºu±s.h
>

13 
	~<sys/°rög.h
>

14 
	~<sys/defs.h
>

16 
check_¥öt_esˇ≥
(c⁄° *
f‹m©
);

17 
¥öt_to_c⁄sﬁe
(c⁄° *
°rög
, 
size
);

18 
upd©e_löe„ed
();

19 
˛ór_c⁄sﬁe
();

20 
v¥ötf
(c⁄° *
f‹m©
,
va_li°
 
¨gs
);

21 
s¸ﬁÀr
(
no_of_löes
);

24 *
	gv_±r
 = (*)0xFFFFFFFF800B8000;

25 
	glöe_no
=24;

26 
	gcﬁumn_no
=80;

29 *
	g°¨tög_addªss_of_VGA_buf„r
 = (*)0xFFFFFFFF800B8000;

30 *
	gíd_addªss_of_VGA_buf„r
 = (*)0xFFFFFFFF800B8F00UL;

32 
uöt64_t
 
	$gë_VGA_addªss
()

34  (
uöt64_t
)
v_±r
;

35 
	}
}

37 
	$£t_VGA_addªss
(
uöt64_t
 
√wadd
)

40 
v_±r
 = (*)
√wadd
;

42 
	}
}

44 
	$föd_row_no
()

46  (((
uöt64_t
)
v_±r
 - (uöt64_t)
°¨tög_addªss_of_VGA_buf„r
)/160);

48 
	}
}

50 
	$föd_cﬁumn_no
()

52  ((((
uöt64_t
)
v_±r
 - (uöt64_t)
°¨tög_addªss_of_VGA_buf„r
)/2)%80);

53 
	}
}

55 
	$£t_¥öt_loˇti⁄
(
löe
, 
cﬁumn
)

57 
uöt64_t
 
√wadd
;

58 
√wadd
 = (
uöt64_t
)
°¨tög_addªss_of_VGA_buf„r
 +(
löe
*160 + 
cﬁumn
*2);

59 
	`£t_VGA_addªss
(
√wadd
);

61 
	}
}

62 
	$s¸ﬁÀr
(
no_löes
){

64 
uöt64_t
 
sour˚
 = (uöt64_t)
°¨tög_addªss_of_VGA_buf„r
 + 
no_löes
*160;

65 
uöt64_t
 
de°ö©i⁄
 = (uöt64_t)
°¨tög_addªss_of_VGA_buf„r
;

66 
uöt64_t
 
num
 = (24-
no_löes
)*160;

67 
	`mem˝y
((*)
de°ö©i⁄
,(*)
sour˚
,
num
);

69 
sour˚
 = (
uöt64_t
)
°¨tög_addªss_of_VGA_buf„r
+
num
;

70 
num
 = 
no_löes
*160;

71 
	`mem£t
((*)
sour˚
,0,
num
);

72 
löe_no
 = 
	`föd_row_no
();

73 
cﬁ_no
 = 
	`föd_cﬁumn_no
();

74 
löe_no
 =Üöe_nÿ- 
no_löes
;

75 
	`£t_¥öt_loˇti⁄
(
löe_no
,
cﬁ_no
);

78 
	}
}

79 
	$check_s¸ﬁl
()

81 
row_no
 = 
	`föd_row_no
();

82 
cﬁ_no
 = 
	`föd_cﬁumn_no
();

83 i‡(
row_no
 >24 && 
cﬁ_no
 < 30 ) {

84 
	`s¸ﬁÀr
(1);

87 
	}
}

88 
	$¥öt_to_c⁄sﬁe
(c⁄° *
°rög
, 
size
)

90 
cou¡
 = 0;

91 *
°rög
 && 
cou¡
 < 
size
) {

92 
	`check_s¸ﬁl
();

93 *
v_±r
 = *
°rög
;

94 ++
°rög
;

95 
v_±r
 +=2;

96 
cou¡
++;

101 
	}
}

102 
	$¥öt_ch¨1
(
√wch¨
)

105 
	`check_s¸ﬁl
();

106 *
v_±r
 = 
√wch¨
;

107 
v_±r
 += 2;

112 
	}
}

113 
	$¥öt_√wlöe
()

115 
löe_no
 = 
	`föd_row_no
() + 1;

116 
	`£t_¥öt_loˇti⁄
(
löe_no
,0);

117 
	`check_s¸ﬁl
();

119 
	}
}

121 
	$¥öt_back•a˚
()

123 i‡(
	`gë_VGA_addªss
(Ë>(
uöt64_t
)
°¨tög_addªss_of_VGA_buf„r
)

125 
	`£t_VGA_addªss
(
	`gë_VGA_addªss
()-2);

126 
	`¥öt_ch¨1
(' ');

127 
	`£t_VGA_addªss
(
	`gë_VGA_addªss
()-2);

130 
	}
}

132 
	$¥öt_èb
()

135 
	`£t_VGA_addªss
(
	`gë_VGA_addªss
()+8);

136 
	`check_s¸ﬁl
();

138 
	}
}

139 
	$check_¥öt_esˇ≥
(c⁄° *
f‹m©
){

140 i‡(*
f‹m©
 == '\n' )

142 
	`¥öt_√wlöe
();

144 } i‡(*
f‹m©
 == '\b')

146 
	`¥öt_back•a˚
();

148 } i‡(*
f‹m©
 == '\t')

150 
	`¥öt_èb
();

155 
	}
}

159 
	$¥öt_°rög
(*
°r
)

161 
size
 = 
	`°æí
(
°r
);

162 
	`¥öt_to_c⁄sﬁe
(
°r
,
size
);

164 
	}
}

167 
	$¥öt_öt
(
num
)

169 
°r
[10], 
ãmp
;

170 
ödex
 = 0, 
j
 = 0;

171 *
t
 = 
°r
;

172 
n
=5;

173 
n
 != 0) {

174 *
t
++ = 0;

175 
n
--;

177 i‡(
num
 == 0){

178 
°r
[
ödex
] = '0';

180 
num
 > 0) {

181 
°r
[
ödex
++] = '0' + (
num
%10);

182 
num
/=10;

185 
j
 = 0; j < 
ödex
/2; j++) {

186 
ãmp
 = 
°r
[
j
];

187 
°r
[
j
] = så[
ödex
-1-j];

188 
°r
[
ödex
-1-
j
] = 
ãmp
;

191 
size
 = 
	`°æí
(
°r
);

193 
	`¥öt_to_c⁄sﬁe
((c⁄° *)
°r
,
size
);

195 
	}
}

198 
	$¥öt_hex
(
addr
) {

199 
¨r
[33];

200 *
±r
 = &
¨r
[(arr)-1];

201 *
±r
 = '\0';

202 
cou¡
 = 0;

203  
addr
 != 0 )

205 *--
±r
="0123456789abcdef"[
addr
%16];

206 
addr
/=16;

207 
cou¡
++;

210 
	`¥öt_to_c⁄sﬁe
(
±r
,
cou¡
);

212 
	}
}

215 
	$¥öt_±r
(*
addr_maö
)

217 
	`¥öt_°rög
("0x");

218 
¨r
[33];

219 
addr
 = (Ë
addr_maö
;

220 *
±r
 = &
¨r
[(arr)-1];

221 *
±r
 = '\0';

222 
cou¡
 = 0;

223  
addr
 != 0 )

225 *--
±r
="0123456789abcdef"[
addr
%16];

226 
addr
/=16;

227 
cou¡
++;

230 
	`¥öt_to_c⁄sﬁe
(
±r
,
cou¡
);

233 
	}
}

237 
	$¥öt_ch¨
(
ch
) {

238 
°r
[2];

239 
°r
[0] = 
ch
;

240 
°r
[1] = '\0';

241 
size
 = 
	`°æí
(
°r
);

242 
	`¥öt_to_c⁄sﬁe
(
°r
,
size
);

244 
	}
}

248 
	$¥öt_löe
(
row
,
cﬁumn
,c⁄° *
°rög
, ...) {

251 *
±r
 = 
v_±r
;

252 
v_±r
 = 
°¨tög_addªss_of_VGA_buf„r
+(2*80*
cﬁumn
+
row
*2);

254 
va_li°
 
vÆ
;

255 
	`va_°¨t
(
vÆ
, 
°rög
);

258 
	`v¥ötf
(
°rög
,
vÆ
);

259 
	`va_íd
(
vÆ
);

261 
v_±r
 = 
±r
;

265 
	}
}

268 
	$check_back_•a˚
(c⁄° *
f‹m©
) {

269 *
•
 =
NULL
;

270 
x
 = 2;

271 i‡(*
f‹m©
 == '\b' ) {

272 
v_±r
v_±r-
x
;

273 *
v_±r
*
•
;

275 i‡(
cﬁumn_no
 == 0) {

276 
cﬁumn_no
 = 79;

277 
löe_no
--;

279 
cﬁumn_no
--;

288 
	}
}

292 
	$˛ór_c⁄sﬁe
() {

293 *
v_±r1
 = (*)0xFFFFFFFF800B8000;

294 
cou¡
 =0;

295 
uöt8_t
 
cﬁ‹
=0;

297 
cou¡
 < (80*23*2)) {

299 *(
v_±r1
+
cou¡
) = ' ';

300 *(
v_±r1
+
cou¡
+1Ë
cﬁ‹
;

301 
cou¡
= count+2;

303 
v_±r
 = 
v_±r1
;

306 
	}
}

309 
	$v¥ötf
(c⁄° *
f‹m©
,
va_li°
 
¨gs
)

311 
¥öãd
 = 0;

312 c⁄° *
ch
;

314 
ªt
;

315 *
f‹m©
 != 0) {

317 i‡(*
f‹m©
 == '%') {

318 
ch
 = 
f‹m©
;

319 ++
f‹m©
;

321 i‡(*
f‹m©
 == '\0'){

324 *
f‹m©
) {

326 
ªt
 = 
	`¥öt_°rög
(
	`va_¨g
(
¨gs
, *));

327 
¥öãd
ıröãd+
ªt
;

331 
	`¥öt_öt
(
	`va_¨g
(
¨gs
, ));

332 
¥öãd
++;

336 
	`¥öt_ch¨
(
	`va_¨g
(
¨gs
, ));

337 
¥öãd
++;

341 
	`¥öt_hex
(
	`va_¨g
(
¨gs
, ));

342 
¥öãd
++;

346 
	`¥öt_±r
(
	`va_¨g
(
¨gs
,*));

347 
¥öãd
++;

351 
	`¥öt_to_c⁄sﬁe
(
ch
,1);

352 
	`¥öt_to_c⁄sﬁe
(
f‹m©
,1);

353 
¥öãd
++;

356 
f‹m©
 = f‹m© + 
	`check_¥öt_esˇ≥
(f‹m©Ë+ 
	`check_back_•a˚
(format);

357 i‡(*
f‹m©
 != '\0'){

358 
	`¥öt_to_c⁄sﬁe
(
f‹m©
,1);

362 
¥öãd
++;

365 
f‹m©
++;

367  
¥öãd
;

368 
	}
}

372 
	$¥ötf
(c⁄° *
f‹m©
, ...) {

373 
va_li°
 
vÆ
;

374 
	`va_°¨t
(
vÆ
, 
f‹m©
);

375 
ªt
 = 
	`v¥ötf
(
f‹m©
,
vÆ
);

376 
	`va_íd
(
vÆ
);

377  
ªt
;

378 
	}
}

427 
öt32_t
 
	$puts
(* 
my°rög
)

430 
öt32_t
 
Àn
 = 0;

437 
Àn
 =
	`¥ötf
(
my°rög
);

438  
Àn
;

439 
	}
}

	@process.c

9 
	~<sys/vmmu.h
>

10 
	~<sys/¥o˚ss.h
>

11 
	~<sys/gdt.h
>

12 
	~<sys/°rög.h
>

13 
	~<sys/sbunix.h
>

14 
	~<sys/ñf.h
>

15 
	~<sys/èrfs.h
>

16 
	~<sys/pm≠.h
>

17 
	~<sys/sysˇŒ.h
>

18 
	~<sys/ñf.h
>

20 
èsk_°ru˘
 *
	gfg_èsk
;

21 
èsk_°ru˘
 *
	g¶ìp_èsk
;

22 
èsk_°ru˘
 *
	gcuºít
;

24 
uöt64_t
 
	g°ack_pos
;

27 
	$gëPro˚ssID
()

29 
id
 = 0;

30 ;
id
 < 
MAX_PROCESS
; id++) {

31 if(
¥o˚ssID
[
id
] == 0) {

32 
¥o˚ssID
[
id
] = 1;

33  
id
;

37 
	}
}

40 
	$öô_¥o˚ss_m≠
()

42 
id
 = 0;

43 ; 
id
 < 
MAX_PROCESS
; id++)

44 
¥o˚ssID
[
id
] = 0;

45 
	}
}

48 
	$öô_func
(){

50 
	`scheduÀ
();

52 
	}
}

55 
	$¸óã_öô_¥o˚ss
()

58 
èsk_°ru˘
 *
öô
 = (èsk_°ru˘ *Ë
	`kmÆloc
();

60 
öô
->
èsk_°©e
 = 
TASK_NEW
;

61 
öô
->
pid
 = 
	`gëPro˚ssID
();

62 
öô
->
µid
 = 0;

63 
öô
->
√xt
 = init;

64 
öô
->
mm
 = 
NULL
;

65 
öô
->
¶ìp
 = 0;

66 
öô
->
waô_⁄_chûd_pid
 = -1;

67 
öô
->
¸3
 = (
uöt64_t
)
	`gë_CR3
();;

68 
öô
->
rù
 = (
uöt64_t
)&
öô_func
;

71 *
k°ack
 = (*)
	`kmÆloc
();

72 
öô
->
r•
 = inô->
öô_kîn
 = inô->
kî√l_°ack
 = ((
uöt64_t
)
k°ack
 +0x1000 - 16);

74 
cuºít
 = 
öô
;

75 
	}
}

78 
èsk_°ru˘
* 
	$¸óã_u£r_¥o˚ss
(*
fûíame
)

81 
posix_hódî_u°¨
 *
fûe
 = 
	`gë_bö¨y
(
fûíame
);

83 if(
fûe
 =
NULL
) {

84 
	`¥ötf
("BinaryÇot found!\n");

85  
NULL
;

88 
pid
 = 
	`gëPro˚ssID
();

91 
èsk_°ru˘
 *
√wProc
 = (èsk_°ru˘ *)
	`kmÆloc
();

92 
√wProc
->
pid
 =Öid;

93 
√wProc
->
èsk_°©e
 = 
TASK_NEW
;

94 
√wProc
->
waô_⁄_chûd_pid
 = -1;

97 
	`°r˝y
(
√wProc
->
cur_dú
,"/rootfs/bin");

98 
ãmp
[30];

99 
	`°r˝y
(
ãmp
,
√wProc
->
cur_dú
);

102 
dú
 *
ªt_dú
 = 
	`sys_›ídú
(
ãmp
);

103 
√wProc
->
cur_node
 = 
ªt_dú
->
node
;

107 
√wProc
->
¸3
 = (
uöt64_t
)
	`£t_u£r_AddrS∑˚
();

108 
PML4
 *
cuº_CR3
 = (PML4 *)
	`gë_CR3
();

111 
	`£t_CR3
((
PML4
 *)
√wProc
->
¸3
);

114 
mm_°ru˘
 *
mm
 = (mm_°ru˘ *)
	`kmÆloc
();

115 
√wProc
->
mm
 = mm;

118 *
kSèck
 = (*)
	`kmÆloc
();

119 
√wProc
->
öô_kîn
 =ÇewProc->
kî√l_°ack
 = ((
uöt64_t
)
kSèck
 + 4096 - 16);

122 
îr‹
 = 
	`lﬂd_exe
(
√wProc
, (*)(
fûe
 + 1));

125 if(
îr‹
)

126  
NULL
;

129 
	`£t_CR3
((
PML4
 *)
cuº_CR3
);

132 
cuºít
->
√xt
 = 
√wProc
;

133 
√wProc
->
√xt
 = 
cuºít
;

134 
cuºít
 = 
√wProc
;

136  
√wProc
;

137 
	}
}

140 
	$swôch_to_rög3
(
èsk_°ru˘
 *
èsk
)

142 
èsk
->
èsk_°©e
 = 
TASK_RUNNING
;

144 vﬁ©ûê
a
 = 0x2B;

146 
__asm
 volatile("movq %0,%%rax;\n\t"

147 "…∏(%%øx);"::"r"(&
a
));

151 
tss
.
r•0
 = 
èsk
->
öô_kîn
;

158 
__asm__
 
	`__vﬁ©ûe__
 (

179 ::"r"(
èsk
->
¸3
), "r"—ask->
r•
),"r"—ask->
rù
)

182 
	}
}

186 * 
	$c›y_èsk_°ru˘
(
èsk_°ru˘
 *
∑ª¡
)

188 
èsk_°ru˘
 *
chûd_èsk
 = (èsk_°ru˘ *)
	`kmÆloc
();

190 
chûd_èsk
->
èsk_°©e
 = 
TASK_NEW
;

191 
chûd_èsk
->
pid
 = 
	`gëPro˚ssID
();

192 
chûd_èsk
->
µid
 = 
∑ª¡
->
pid
 ;

193 
chûd_èsk
->
√xt
 = 
NULL
;

194 
chûd_èsk
->
mm
 = 
NULL
;

195 
chûd_èsk
->
¶ìp
 = 0;

196 
chûd_èsk
->
waô_⁄_chûd_pid
 = -1;

197 
∑ª¡
->
nchûd
 = 1;

200 
chûd_èsk
->
¸3
 = (
uöt64_t
)
	`Æloˇã_∑ge
();

201 
	`£tup_chûd_∑gëabÀ
(
chûd_èsk
->
¸3
);

204 
	`£t_CR3
((
PML4
 *)
chûd_èsk
->
¸3
);

207 
	`mem˝y
(&(
chûd_èsk
->
fd
[0]),&(
∑ª¡
->fd[0]),(’¨ít->fd[0])* 
MAX_FD
));

210 
chûd_èsk
->
mm
 = 
	`kmÆloc
();

211 
	`mem˝y
(
chûd_èsk
->
mm
, 
∑ª¡
->mm, (
mm_°ru˘
));

214 
vma_°ru˘
 *
∑ª¡_vma
 = 
∑ª¡
->
mm
->
mm≠
;

215 
vma_°ru˘
 *
chûd_vma
 = 
NULL
;

217 
∑ª¡_vma
) {

219 
chûd_vma
 = (
vma_°ru˘
 *)
	`kmÆloc
();

221 
	`mem˝y
(
chûd_vma
, 
∑ª¡_vma
, (
vma_°ru˘
));

223 if(
∑ª¡_vma
->
fûe
!=
NULL
){

224 
chûd_vma
->
fûe
 = 
	`kmÆloc
();

225 
	`mem˝y
(
chûd_vma
->
fûe
,
∑ª¡_vma
->file,(file));

228 if(
chûd_vma
->
√xt
)

229 
chûd_vma
 = chûd_vma->
√xt
;

230 
∑ª¡_vma
 =Ö¨ít_vma->
√xt
;

236 if(!
chûd_vma
) {

237 
chûd_èsk
->
mm
->
mm≠
 = 
NULL
;

238 
ªt
;

241 
chûd_vma
->
√xt
 = 
NULL
;

244 
ªt
:

245  (*)
chûd_èsk
;

247 
	}
}

249 
	$sys_f‹k
()

251 
èsk_°ru˘
 *
ãmp
, *
∑ª¡
 = 
NULL
;

254 
èsk_°ru˘
 *
chûd
 = (èsk_°ru˘ *)
	`c›y_èsk_°ru˘
(—ask_°ru˘*)
cuºít
);

257 
ãmp
 = 
cuºít
->
√xt
;

258 
cuºít
->
√xt
 = 
chûd
;

259 
chûd
->
√xt
 = 
ãmp
;

261 
∑ª¡
 = 
cuºít
;

267 *
k°ack
 = (*)
	`kmÆloc
();

268 
chûd
->
öô_kîn
 = chûd->
kî√l_°ack
 = ((
uöt64_t
)
k°ack
 + 4096 - 16);

269 
	`mem˝y
((*)(
chûd
->
öô_kîn
 - 0x1000 +16), (*)(
∑ª¡
->init_kern - 0x1000 +16), 4096);

272 
	`£t_CR3
((
PML4
 *)
∑ª¡
->
¸3
);

281 
__asm__
 
	`__vﬁ©ûe__
 (

285 :"=g"(
chûd
->
rù
),"=m"(
°ack_pos
)

288 if(
cuºít
 =
∑ª¡
) {

293 
chûd
->
kî√l_°ack
 = chûd->
öô_kîn
 - (
∑ª¡
->öô_kî¿- 
°ack_pos
);

294  
chûd
->
pid
;

298 
°ack_pos
 = 0;

299 
	`outb
(0x20, 0x20);

302 
	}
}

304 
	$c⁄ãxt_swôch
(
èsk_°ru˘
 *
√xt
,Åask_°ru˘ *
¥ev
) {

306 
tss
.
r•0
 = 
√xt
->
öô_kîn
;

308 
__asm__
 
	`__vﬁ©ûe__
 (

317 :"=g"(
¥ev
->
rù
)

318 :"r"(&(
¥ev
->
kî√l_°ack
)), "r"(
√xt
->kî√l_°ack), "r"“ext->
rù
), "r"“ext->
¸3
)

320 
	}
}

324 
	$scheduÀ
()

326 
èsk_°ru˘
 *
¥ev
 = (èsk_°ru˘*)
cuºít
;

328 
cuºít
 = cuºít->
√xt
;

329 if(
cuºít
 !
¥ev
)

330 
	`c⁄ãxt_swôch
–(
èsk_°ru˘
*)
cuºít
, 
¥ev
);

332 
	}
}

335 
	$‰ì_mem‹y_m≠
(
mm_°ru˘
 *
mm
)

337 if(
mm
->
mm≠
 =
NULL
)

340 
vma_°ru˘
 *
vma
 = 
mm
->
mm≠
;

341 
vma
 !
NULL
) {

342 
vma_°ru˘
 *
‰ì_vma
 = 
vma
;

343 
vma
 = vma->
√xt
;

344 
	`k‰ì
((
uöt64_t
)
‰ì_vma
);

347 
	}
}

350 
	$sys_execve
(*
fûíame
, **
¨gv
, **
ívp
)

352 
i
=0, 
¨gc
=0;

354 
c_±r
[5][24];

356 
i
 = 0; i < 5; ++i)

357 
c_±r
[
i
][0] = '\0';

359 if(
¨gv
 !
NULL
){

360 
¨gv
[
¨gc
] !
NULL
){

361 
	`°r˝y
(
c_±r
[
¨gc
],
¨gv
[argc]);

362 
¨gc
++;

367 
èsk_°ru˘
 *
èsk
 = (èsk_°ru˘ *)
	`kmÆloc
();

370 
èsk
->
pid
 = 
cuºít
->pid;

371 
èsk
->
µid
 = 
cuºít
->ppid;

374 
	`mem˝y
(&(
èsk
->
fd
[0]),&(
cuºít
->fd[0]),((cuºít->fd[0])* 
MAX_FD
));

377 
posix_hódî_u°¨
 *
fûe
 = 
	`gë_bö¨y
(
fûíame
);

379 if(
fûe
 =
NULL
) {

380 
	`¥ötf
("BinaryÇot found!\n");

384 
èsk
->
¸3
 = (
uöt64_t
)
	`£t_u£r_AddrS∑˚
();

385 
PML4
 *
cuº_CR3
 = (PML4 *)
	`gë_CR3
();

387 
	`£t_CR3
((
PML4
 *)
èsk
->
¸3
);

390 *
k°ack
 = (*)
	`kmÆloc
();

391 
èsk
->
öô_kîn
 =Åask->
kî√l_°ack
 = ((
uöt64_t
)
k°ack
 + 4096 - 16);

394 
mm_°ru˘
 *
mm
 = (mm_°ru˘ *)
	`kmÆloc
();

395 
èsk
->
mm
 = mm;

398 
îr‹
 = 
	`lﬂd_exe
(
èsk
, (*)(
fûe
 + 1));

401 if(
îr‹
)

404 *
±r
 = (*)(
USER_STACK_TOP
 + 0x1000 - 16 - (
c_±r
));

405 
	`mem˝y
(
±r
, (*)
c_±r
, (c_ptr));

407 
i
=
¨gc
;i>0;i--){

409 *(
uöt64_t
*)(
±r
 - 8*
i
Ë(uöt64_tÌå + (
¨gc
-i)*24;

412 
±r
 =Öå- 8*
¨gc
;

413 
èsk
->
r•
 = (
uöt64_t
)
±r
;

415 
	`£t_CR3
((
PML4
 *)
cuº_CR3
);

428 
èsk_°ru˘
 *
¥ev
 = 
cuºít
->
√xt
;

429 
¥ev
->
√xt
 !
cuºít
)

430 
¥ev
 =Öªv->
√xt
;

433 
¥ev
->
√xt
 = 
èsk
;

434 
èsk
->
√xt
 = 
cuºít
->next;

437 
cuºít
 = 
èsk
;

441 
	`°r˝y
(
èsk
->
cur_dú
,"/rootfs/bin");

442 
ãmp
[30];

443 
	`°r˝y
(
ãmp
,
èsk
->
cur_dú
);

447 
tss
.
r•0
 = 
èsk
->
öô_kîn
;

450 
__asm__
 vﬁ©ûe("movq %0, %%¸3"::"r"(
èsk
->
¸3
));

452 
__asm__
 
	`__vﬁ©ûe__
 (

473 ::"r"(
èsk
->
¸3
), "r"—ask->
r•
), "r"—ask->
rù
), "r"—ask->
kî√l_°ack
),"r"(
±r
), "m"(
¨gc
)

479 
	}
}

481 
	$«no_¶ìp
(
uöt64_t
 
°ime
)

484 
cuºít
->
¶ìp
 = 
°ime
;

485 
èsk_°ru˘
 *
ãmp
 = 
cuºít
;

488 
ãmp
->
√xt
 !
cuºít
) {

489 
ãmp
 =Åemp->
√xt
;

492 
ãmp
->
√xt
 = 
cuºít
->next;

495 
cuºít
->
√xt
 = 
¶ìp_èsk
;

496 
¶ìp_èsk
 = 
cuºít
;

497 
¶ìp_èsk
->
èsk_°©e
 = 
TASK_WAITING
;

500 
cuºít
 = 
ãmp
->
√xt
;

501 
	`c⁄ãxt_swôch
(
cuºít
, 
¶ìp_èsk
);

504 
	}
}

506 
	$de¸emít_¶ìp_time
()

509 if(
¶ìp_èsk
 =
NULL
)

512 
èsk_°ru˘
 *
èsk
, *
ãmp
, *
cur
;

513 
ãmp
 = 
¶ìp_èsk
;

514 
èsk
 = 
cuºít
;

515 i‡(
ãmp
 =
NULL
)

518 if(
ãmp
->
¶ìp
 <0 &&Åemp->
waô_⁄_chûd_pid
 == -1) {

520 
cur
 = 
èsk
->
√xt
;

521 
èsk
->
√xt
 = 
ãmp
;

522 
¶ìp_èsk
 = 
ãmp
->
√xt
;

523 
ãmp
->
√xt
 = 
cur
;

524 
ãmp
->
èsk_°©e
 = 
TASK_RUNNING
;

526 
	`¥ötf
("\¿de¸emítögÅimê %d\n",
ãmp
->
¶ìp
);

527 i‡(
ãmp
->
¶ìp
 <= 0)

529 
ãmp
) {

530 
uöt64_t
 
s_time
 = 
ãmp
->
¶ìp
;

531 
s_time
--;

532 
ãmp
->
¶ìp
 = 
s_time
;

534 if(
ãmp
->
¶ìp
 <0 &&Åemp->
waô_⁄_chûd_pid
 == -1) {

535 
cur
 = 
èsk
->
√xt
;

536 
èsk
->
√xt
 = 
ãmp
->next;

537 
¶ìp_èsk
 = 
ãmp
->
√xt
->next;

538 
ãmp
->
√xt
->√xà
cur
;

539 
ãmp
->
èsk_°©e
 = 
TASK_RUNNING
;

541 
ãmp
 =Åemp->
√xt
;

544 
	}
}

548 
	$exô_èsk
(
èsk_°ru˘
 *
èsk
)

550 
	`‰ì_mem‹y_m≠
(
èsk
->
mm
);

551 
	`k‰ì
((
uöt64_t
)
èsk
->
mm
);

552 
èsk
->
mm
 = 
NULL
;

554 
	`dñëe_∑gëabÀ
(
èsk
->
¸3
);

556 
	`k‰ì
((
uöt64_t
)
èsk
->
öô_kîn
);

558 
	`k‰ì
((
uöt64_t
)
èsk
);

560 
	}
}

568 
	$exô
(
exô_°©us
)

571 
èsk_°ru˘
 *
èsk_ªmove
 = 
cuºít
;

572 
èsk_°ru˘
 *
±r
 = 
cuºít
->
√xt
;

573 
èsk_°ru˘
 *
∑ª¡
 = 
NULL
, *
ãmp
;

575 
ãmp
 = 
¶ìp_èsk
;

577 
±r
->
√xt
 !
cuºít
)

578 
±r
 =Öå->
√xt
;

584 if(
¶ìp_èsk
) {

586 
∑ª¡
 = 
ãmp
->
√xt
;

587 if(
ãmp
->
waô_⁄_chûd_pid
 =
cuºít
->
pid
) {

588 
¶ìp_èsk
 = sÀï_èsk->
√xt
;

589 
ãmp
->
nchûd
 -= 1;

590 
∑ª¡
 = 
ãmp
;

593 
∑ª¡
) {

595 if(
∑ª¡
->
waô_⁄_chûd_pid
 =
cuºít
->
pid
)

598 
∑ª¡
->
nchûd
 -= 1;

599 
∑ª¡
->
èsk_°©e
 = 
TASK_RUNNING
;

600 
ãmp
->
√xt
 = 
∑ª¡
->next;

603 
∑ª¡
 =Ö¨ít->
√xt
;

604 
ãmp
 =Åemp->
√xt
;

609 if(
∑ª¡
) {

610 
∑ª¡
->
√xt
 = 
èsk_ªmove
->next;

612 if(
∑ª¡
)

613 
±r
->
√xt
 = 
∑ª¡
;

615 
±r
->
√xt
 = 
èsk_ªmove
->next;

618 
	`exô_èsk
(
èsk_ªmove
);

621 
cuºít
 = 
±r
;

624 
	`c⁄ãxt_swôch
(
cuºít
, 
èsk_ªmove
);

625 
	}
}

	@string.c

9 
	~<°dio.h
>

10 
	~<°rög.h
>

12 
	g°r
[10];

14 
	$°r˝y
(

15 *
de°
,

16 c⁄° *
§c
)

18 c⁄° *
ßved
 = 
de°
;

20 *
§c
){

21 *
de°
 = *
§c
;

22 
§c
++;

23 
de°
++;

25 *
de°
 = '\0';

27  
ßved
;

28 
	}
}

31 
	$°∫˝y
(

32 *
de°
,

33 c⁄° *
§c
,

34 
cou¡
)

36 c⁄° *
ßved
 = 
de°
;

38 
cou¡
 && *
§c
) {

39 *
de°
 = *
§c
;

40 
§c
++;

41 
de°
++;

42 
cou¡
--;

44 *
de°
 = '\0';

46  
ßved
;

47 
	}
}

50 
	$°rcmp
(

51 c⁄° *
°r1
,

52 c⁄° *
°r2
)

54 *
°r1
 && *
°r2
 && *str1 == *str2) {

55 
°r1
++;

56 
°r2
++;

59  *
°r1
 - *
°r2
;

60 
	}
}

63 
	$°∫cmp
(

64 c⁄° *
°r1
,

65 c⁄° *
°r2
,

66 
cou¡
)

68 
cou¡
) {

69 if(*
°r1
 && *
°r2
 && *str1 == *str2) {

70 
°r1
++;

71 
°r2
++;

73  *
°r1
-*
°r2
;

76 
cou¡
--;

81 
	}
}

85 
	$°æí
(

86 c⁄° *
°r
)

88 
Àn
 = 0;

90 *
°r
++)

91 
Àn
++;

93  
Àn
;

94 
	}
}

97 
	$°rˇt
(

98 *
√w
,

99 c⁄° *
‹ig
)

101 *
√w
++);

103 (*
√w
++ = *
‹ig
++));

105 *
√w
 = '\0';

106 
	}
}

109 
	$°∫ˇt
(

110 *
√w
,

111 c⁄° *
‹ig
,

112 
cou¡
)

114 if(
cou¡
) {

115 *++
√w
);

117 
cou¡
 && *
‹ig
){

118 *
√w
++ = *
‹ig
++;

119 
cou¡
--;

122 *
√w
 = '\0';

124 
	}
}

131 
	$ödex
(

132 *
°r
,

133 
chr
)

135 *
°r
) {

136 i‡(*
°r
 =
chr
)

137  (*Ë
°r
;

139 
°r
++;

142  
NULL
;

143 
	}
}

150 
	$bzîo
(

151 *
°rög
,

152 
byãs
)

154 *
ªs
 = 
°rög
;

156 
byãs
 != 0) {

157 *
ªs
++ = 0;

158 
byãs
--;

160 
	}
}

168 * 
	$°πok
(

169 * 
∑r£_°r
,

170 c⁄° * 
dñims
)

173 *
tokí
 = 
NULL
;

174 *
°r_±r
 = 
NULL
;

175 
ödex
 = 0;

176 
°r_Àn
 = 
	`°æí
(
dñims
);

178 if(!
∑r£_°r
 && !
tokí
)

179  
NULL
;

181 if(
∑r£_°r
 && !
tokí
)

182 
tokí
 = 
∑r£_°r
;

188 
°r_±r
 = 
tokí
;

190 
ödex
 = 0; index < 
°r_Àn
; index ++) {

191 if(*
°r_±r
 =
dñims
[
ödex
]) {

192 
°r_±r
 ++;

197 if(
ödex
 =
°r_Àn
) {

198 
tokí
 = 
°r_±r
;

208 if(*
tokí
 == '\0') {

209 
tokí
 = 
NULL
;

210  
tokí
;

214 *
tokí
 != '\0') {

215 
ödex
 = 0; index < 
°r_Àn
; index ++) {

216 if(*
tokí
 =
dñims
[
ödex
]) {

217 *
tokí
 = '\0';

222 
tokí
 ++;

224 i‡(
ödex
 < 
°r_Àn
)

228  
°r_±r
;

229 
	}
}

231 
	$mem£t
(*
±r
, 
vÆue
, 
uöt64_t
 
num
)

233 
i
 = 0;

234 ; 
i
 < 
num
; i++)

235 ((*)
±r
)[
i
] = 0;

236 
	}
}

238 *
	$mem˝y
(*
de°
, c⁄° *
§c
, 
uöt64_t
 
n
)

240 *
pd
 = (*)
de°
;

241 c⁄° *
ps
 = (*)
§c
;

242 i‡–
ps
 < 
pd
 )

243 
pd
 +
n
, 
ps
 +=Ç;Ç--;)

244 *--
pd
 = *--
ps
;

246 
n
--)

247 *
pd
++ = *
ps
++;

248  
de°
;

249 
	}
}

250 *
	$öt_to_°r
(
num
)

253 
ãmp
;

254 
ödex
 = 0, 
j
 = 0;

255 *
t
 = 
°r
;

256 
n
=5;

257 
n
 != 0) {

258 *
t
++ = 0;

259 
n
--;

261 i‡(
num
 == 0){

262 
°r
[
ödex
] = '0';

264 
num
 > 0) {

265 
°r
[
ödex
++] = '0' + (
num
%10);

266 
num
/=10;

269 
j
 = 0; j < 
ödex
/2; j++) {

270 
ãmp
 = 
°r
[
j
];

271 
°r
[
j
] = så[
ödex
-1-j];

272 
°r
[
ödex
-1-
j
] = 
ãmp
;

275  
°r
;

276 
	}
}

	@syscall.c

1 
	~<sys/öãºu±s.h
>

2 
	~<sys/vmmu.h
>

3 
	~<sys/°rög.h
>

4 
	~<sys/pm≠.h
>

5 
	~<sys/sbunix.h
>

6 
	~<sys/defs.h
>

7 
	~<sys/sysˇŒ.h
>

8 
	~<sys/¥o˚ss.h
>

9 
	~<sys/dúít.h
>

10 
	~<sys/ñf.h
>

12 
	#FD_MAX
 100

	)

13 
	#PAGESIZE
 4096

	)

14 
	#TRUE
 1

	)

15 
	#FALSE
 0

	)

16 
	#MAX_DIR_SIZE
 30

	)

17 
	#RD_PIPE
 2

	)

18 
	#WR_PIPE
 1

	)

19 
	#NO_PIPE
 0

	)

20 
	gbuf„r
[100];

21 íum { 
	mSEEK_SET
 = 0, 
	mSEEK_CUR
 = 1, 
	mSEEK_END
 = 2 };

22 íum { 
	mO_RDONLY
 = 0, 
	mO_WRONLY
 = 1, 
	mO_RDWR
 = 2, 
	mO_CREAT
 = 0x40, 
	mO_DIRECTORY
 = 0x10000 };

24 
èsk_°ru˘
 *
cuºít
;

25 
	gpùe_buf„r
[4096];

26 
	$sysˇŒ_h™dÀr
(
i§_ªgs
 *
ªgs
){

28 
uöt64_t
 
no_ªtu∫ed
;

29 
uöt64_t
 
ªtu∫_vÆue
;

31 
no_ªtu∫ed
 = 
ªgs
->
øx
;

32 
ªtu∫_vÆue
 = 
	`sysˇŒ_ˇŒî
(
no_ªtu∫ed
,
ªgs
->
rdi
,ªgs->
rsi
,ªgs->
rdx
);

33 
ªgs
->
øx
 = 
ªtu∫_vÆue
;

35 *((
öt64_t
 *)
cuºít
->
öô_kîn
 - 9Ë
ªtu∫_vÆue
;

40 
	}
}

43 
uöt64_t
 
	$sysˇŒ_ˇŒî
(
uöt64_t
 
no_ªtu∫ed
,uöt64_à
∑r1
,uöt64_à
∑r2
,uöt64_à
∑r3
){

45 
no_ªtu∫ed
) {

47 
SYS_exô
:

48 
	`sys_exô
();

50 
SYS_brk
:

51  
	`sys_brk
((
uöt64_t
)
∑r1
);

52 
SYS_f‹k
:

53  
	`sys_f‹k
();

54 
SYS_gëpid
:

55  
	`sys_gëpid
();

56 
SYS_gëµid
:

57  
	`sys_gëµid
();

58 
SYS_execve
:

59  
	`sys_execve
((*)
∑r1
,(**)
∑r2
,(**)
∑r3
);

60 
SYS_waô4
:

61  
	`sys_waôpid
((
uöt64_t
Ë
∑r1
,(uöt64_tË
∑r2
,(uöt64_tË
∑r3
);

62 
SYS_«no¶ìp
:

63  
	`sys_¶ìp
((
uöt64_t
)
∑r1
);

64 
SYS_Æ¨m
:

65  
	`sys_Æ¨m
((
uöt64_t
)
∑r1
);

66 
SYS_gëcwd
:

67  
	`sys_gëcwd
((*)
∑r1
,(
uöt64_t
)
∑r2
);

68 
SYS_chdú
:

69  
	`sys_chdú
((*)
∑r1
);

70 
SYS_›í
:

71  
	`sys_›í
((*)
∑r1
,(
uöt64_t
)
∑r2
);

72 
SYS_ªad
:

73  
	`sys_ªad
((
uöt64_t
)
∑r1
,(uöt64_t)
∑r2
,(uöt64_t)
∑r3
);

74 
SYS_wrôe
:

75  
	`sys_wrôe
((
uöt64_t
)
∑r1
,(uöt64_t)
∑r2
,(uöt64_t)
∑r3
);

76 
SYS_l£ek
:

77  
	`sys_l£ek
((
uöt64_t
)
∑r1
,(uöt64_t)
∑r2
,(uöt64_t)
∑r3
);

78 
SYS_˛o£
:

79 
	`sys_˛o£
((
uöt64_t
)
∑r1
);

81 
SYS_dup
:

82  
	`sys_dup
((
uöt64_t
)
∑r1
);

83 
SYS_dup2
:

84  
	`sys_dup2
((
uöt64_t
)
∑r1
,(uöt64_t)
∑r2
);

85 
SYS_gëdíts
:

86  
	`sys_gëdíts
((
uöt64_t
)
∑r1
,(uöt64_t)
∑r2
,(uöt64_t)
∑r3
);

87 
SYS_›ídú
:

88  (
uöt64_t
)
	`sys_›ídú
((*)
∑r1
);

89 
SYS_ªaddú
:

90  (
uöt64_t
)
	`sys_ªaddú
((
dú
 *)
∑r1
);

91 
SYS_˛o£dú
:

92  (
uöt64_t
)
	`sys_˛o£dú
((
dú
 *)
∑r1
);

93 
SYS_li°¥o˚ss
:

94  
	`sys_li°¥o˚ss
((
uöt64_t
)
∑r1
);

95 
SYS_kûÕro˚ss
:

96  
	`sys_kûÕro˚ss
((
uöt64_t
)
∑r1
);

97 
SYS_˛órs¸ìn
:

98  
	`sys_˛órs¸ìn
();

99 
SYS_li°fûes
:

100  
	`sys_li°fûes
((*)
∑r1
,(
uöt64_t
)
∑r2
);

101 
SYS_ˇtfûes
:

102  
	`sys_ˇtfûes
((*)
∑r1
,(
uöt64_t
)
∑r2
);

103 
SYS_echofûes
:

104  
	`sys_echofûes
((*)
∑r1
,(
uöt64_t
)
∑r2
);

112 
	}
}

114 
	$sys_˛órs¸ìn
() {

116 
	`˛ór_c⁄sﬁe
();

119 
	}
}

123 
	$sys_gëpid
()

125 
pid_sys
 = (Ë
cuºít
->
pid
;

126  
pid_sys
;

127 
	}
}

129 
	$sys_gëµid
()

131 
pid_sys
 = ()
cuºít
->
µid
;

132  
pid_sys
;

133 
	}
}

136 
	$sys_¶ìp
(
uöt64_t
 
£c⁄ds
)

138 
	`«no_¶ìp
(
£c⁄ds
);

139  
cuºít
->
¶ìp
;

141 
	}
}

142 *
	$¥öt_°©e
(
èsk_°©e
){

144 
èsk_°©e
) {

146 
TASK_NEW
:

148 
TASK_RUNNING
:

150 
TASK_INTERRUPTIBLE
 :

152 
TASK_UNINTERRUPTIBLE
:

154 
TASK_STOPPED
:

156 
TASK_ZOMBIE
:

158 
TASK_WAITING
:

163  
NULL
;

165 
	}
}

168 
	$sys_li°¥o˚ss
(
pùe_Êag
) {

170 
cou¡
 =1;

172 
èsk_°ru˘
 *
ãmp
 = 
cuºít
;

173 
èsk_°ru˘
 *
hód1
 = 
cuºít
;

174 *
pùe
 = 
pùe_buf„r
;

175 i‡(
pùe_Êag
 =
RD_PIPE
){

176 
	`¥ötf
("readÖipeÉnabled \n");

177 
	`¥ötf
("ªad d©®i†%s",
pùe_buf„r
);

178 }i‡(
pùe_Êag
 =
WR_PIPE
){

179 
	`bzîo
(
pùe_buf„r
,1092);

185 i‡(
pùe_Êag
 !
WR_PIPE
){

186 
	`¥ötf
("\n LIST of TASKS ");

187 
	`¥ötf
("\n No|pid|ppid| state |Çame ");

189 
	`°r˝y
(
pùe
,"\n LIST of TASKS \n No|pid|ppid| state |Çame ");

191 *
ãmp_pùe
;

194 i‡(
pùe_Êag
 !=
WR_PIPE
) {

195 
	`¥ötf
("\n %d | %d | %d | %s |%s",

196 
cou¡
++,
ãmp
->
pid
,ãmp->
µid
,
	`¥öt_°©e
—emp->
èsk_°©e
),ãmp->
≤ame
 );

197 
ãmp
 =Åemp->
√xt
;

200 
ãmp_pùe
 = 
pùe
 + 
	`°æí
(pipe);

202 
	`°r˝y
(
ãmp_pùe
,"\n ");

203 
ãmp_pùe
 += 2;

204 *
ãmp_p
 = 
	`öt_to_°r
(
cou¡
);

205 
	`°r˝y
(
ãmp_pùe
,
ãmp_p
);

206 
ãmp_pùe
 +
	`°æí
(
ãmp_p
);

207 
cou¡
++;

209 
	`°r˝y
(
ãmp_pùe
,"| ");

210 
ãmp_pùe
 += 2;

211 
ãmp_p
 = 
	`öt_to_°r
(
ãmp
->
pid
);

212 
	`°r˝y
(
ãmp_pùe
,
ãmp_p
);

213 
ãmp_pùe
 +
	`°æí
(
ãmp_p
);

215 
	`°r˝y
(
ãmp_pùe
,"| ");

216 
ãmp_pùe
 += 2;

217 
ãmp_p
 = 
	`öt_to_°r
(
ãmp
->
µid
);

218 
	`°r˝y
(
ãmp_pùe
,
ãmp_p
);

219 
ãmp_pùe
 +
	`°æí
(
ãmp_p
);

221 
	`°r˝y
(
ãmp_pùe
,"| ");

222 
ãmp_pùe
 += 2;

223 
	`°r˝y
(
ãmp_pùe
,
	`¥öt_°©e
(
ãmp
->
èsk_°©e
));

224 
ãmp_pùe
 +
	`°æí
(
	`¥öt_°©e
(
ãmp
->
èsk_°©e
));

226 
	`°r˝y
(
ãmp_pùe
,"| ");

227 
ãmp_pùe
 += 2;

228 
	`°r˝y
(
ãmp_pùe
,
ãmp
->
≤ame
);

232 }
ãmp
 !
hód1
);

233 
	`¥ötf
("\n");

236 
	}
}

240 
	$sys_waôpid
(
uöt64_t
 
chûdpid
,uöt64_à
°©us
,uöt64_à
›ti⁄s
)

245 i‡(
chûdpid
 > 0) {

246 
cuºít
->
waô_⁄_chûd_pid
 = 
chûdpid
;

248 
cuºít
->
waô_⁄_chûd_pid
 = 0;

251 
cuºít
->
èsk_°©e
 = 
TASK_WAITING
;

253 
	`«no_¶ìp
(0);

259 
	}
}

262 
uöt64_t
 
	$sys_gëcwd
(*
buf
, 
uöt64_t
 
size
)

265 i‡(
size
 < 
	`°æí
(
cuºít
->
cur_dú
)) {

268 
	`°r˝y
(
buf
,
cuºít
->
cur_dú
);

270  (
uöt64_t
)
buf
;

272 
	}
}

274 
	$sys_Æ¨m
(
£c⁄d
)

276 
èsk_°ru˘
 *
cur_èsk
 =
cuºít
;

277 
cur_èsk
->
¶ìp
 = 
£c⁄d
;

278 
cur_èsk
->
èsk_°©e
 = 
TASK_WAITING
;

279 
cur_èsk
->
Æ¨m
 = 
TRUE
;

280  
£c⁄d
;

281 
	}
}

283 
	$sys_exô
()

286 
èsk_°ru˘
 *
cur_èsk
 = 
cuºít
;

292 
cur_èsk
->
èsk_°©e
 = 
TASK_STOPPED
;

294 
	`exô
(0);

295 
	}
}

298 
uöt64_t
 
	$sys_dup
(
uöt64_t
 
ﬁdfd
)

300 
èsk_°ru˘
 *
cuº_èsk
 = 
cuºít
;

301 
cou¡
 = 2;

303 i‡(
cuº_èsk
->
fd
[
ﬁdfd
] =
NULL
)

304  
ﬁdfd
;

307 (
cuº_èsk
->
fd
[++
cou¡
] !
NULL
Ë&& cou¡ < 
FD_MAX
);

309 i‡(
cou¡
 >
MAX_FD
)

312 
cuº_èsk
->
fd
[
cou¡
] = cuº_èsk->fd[
ﬁdfd
];

313  
cou¡
;

316 
	}
}

318 
uöt64_t
 
	$sys_dup2
(
uöt64_t
 
ﬁdfd
, uöt64_à
√wfd
)

320 
èsk_°ru˘
 *
cuºít_èsk
 = 
cuºít
;

321 i‡(
√wfd
 > 
MAX_FD
 || 
ﬁdfd
 > MAX_FD)

325 i‡(
√wfd
 =
ﬁdfd
)

326  
√wfd
;

328 i‡(
cuºít_èsk
->
fd
[
√wfd
] !
NULL
){

329 
cuºít_èsk
->
fd
[
√wfd
] = 
NULL
;

330 
cuºít_èsk
->
fd
[
√wfd
] = cuºít_èsk->fd[
ﬁdfd
];

332 
cuºít_èsk
->
fd
[
√wfd
] = cuºít_èsk->fd[
ﬁdfd
];

334  
√wfd
;

337 
	}
}

339 
	$sys_›í
(*
∑th
, 
uöt64_t
 
Êag
 )

341 
fûe_t
 *
node
;

342 
fûe_t
 *
node_ãmp
;

343 *
«me
;

344 *
dú∑th
;

345 
i
=0;

346 
cou¡
 = 2;

347 
fd
 *
fd1
 = (fd*)
	`kmÆloc
();

348 
node
 = 
roŸ
;

350 
dú∑th
 = (*)
	`kmÆloc
();

351 
	`°r˝y
(
dú∑th
,
∑th
);

353 
«me
 = 
	`°πok
(
dú∑th
,"/");

355 i‡(
«me
 =
NULL
)

358 i‡(
	`°rcmp
(
«me
, "rootfs") == 0) {

359  
«me
 !=
NULL
 ) {

360 
node_ãmp
 = 
node
;

361 i‡(
	`°rcmp
(
«me
,".") == 0 ) {

362 
node
 =Çode->
chûd
[0];

364 } i‡(
	`°rcmp
(
«me
,"..") == 0) {

365 
node
 =Çode->
chûd
[1];

369 
i
=2; i < 
node
->
œ°
 ; i++) {

371 i‡(
	`°rcmp
(
«me
,
node
->
chûd
[
i
]->name) == 0) {

372 
node
 = (
fûe_t
 *Íode->
chûd
[
i
];

378 i‡(
i
 >
node_ãmp
->
œ°
)

381 
«me
 = 
	`°πok
(
NULL
,"/");

383 i‡((
node
->
ty≥
 =
DIRECTORY
 && 
Êag
 =(
O_DIRECTORY
 | 
O_RDONLY
)Ë|| (node->ty≥ =
FILE
))

385 
fd1
->
node
 =Çode;

386 
fd1
->
≥rmissi⁄
 =
Êag
;

387 
fd1
->
cuºít
 = 
node
->
fú°
;

392 (
cuºít
->
fd
[++
cou¡
] !
NULL
Ë&& cou¡ < 
FD_MAX
);

394 i‡(
cou¡
 >
FD_MAX
)

397 
cuºít
->
fd
[
cou¡
] = 
fd1
;

398  
cou¡
;

403 
	}
}

406 
uöt64_t
 
	$sys_brk
(
uöt64_t
 
∑ges
)

408 
uöt64_t
 
addr
 = 
cuºít
->
mm
->
brk
;

410 
mm_°ru˘
 *
mm_±r
 = 
cuºít
->
mm
;

411 
uöt64_t
 
size
;

412 
size
 = 
∑ges
*
PAGESIZE
;

424 
mm_±r
->
brk
 +=
size
;

425 
mm_±r
->
íd_d©a
 +=
size
;

426 
mm_±r
->
tŸÆ_vm
 +=
size
;

427  
addr
;

428 
	}
}

431 
	$sys_ªad
(
uöt64_t
 
fd_cou¡
,uöt64_à
addr
,uöt64_à
Àn
)

434 
uöt64_t
 
Àn_ªad
=0;

435 
uöt64_t
 
Àn_íd
 =0;

436 
uöt64_t
 
cou¡
;

439 i‡(
fd_cou¡
 =
°dö
) {

440 
cou¡
 = 
	`sˇnf_°dö
((*)
addr
,
Àn
);

441  
cou¡
;

444 i‡((
cuºít
->
fd
[
fd_cou¡
] !
NULL
Ë&& (cuºít->fd[fd_cou¡]->
≥rmissi⁄
 !
O_WRONLY
)) {

445 
Àn_ªad
 = 
cuºít
->
fd
[
fd_cou¡
]->current;

446 
Àn_íd
 = 
cuºít
->
fd
[
fd_cou¡
]->
node
->
œ°
;

447 i‡(
Àn
 > (
Àn_íd
 - 
Àn_ªad
))

448 
Àn
 = 
Àn_íd
 - 
Àn_ªad
;

449 
cuºít
->
fd
[
fd_cou¡
]->cuºíà+=
Àn
;

450 
	`mem˝y
((*)
addr
,(*)
Àn_ªad
,
Àn
);

452  
Àn
;

456 
	}
}

458 
	$sys_˛o£
(
fd_cou¡
)

460 
cuºít
->
fd
[
fd_cou¡
] = 
NULL
;

461 
	}
}

464 
	$sys_wrôe
(
uöt64_t
 
fd_cou¡
, uöt64_à
addr
, 
Àn
)

468 i‡(
fd_cou¡
 =
°dout
 || fd_cou¡ =
°dîr
) {

469 
Àn
 =
	`¥ötf
((*)
addr
);

470  
Àn
;

475 
	}
}

478 
	$sys_l£ek
(
uöt64_t
 
fd_cou¡
, 
off£t
, 
whí˚
) {

481 
uöt64_t
 
fú°
 =0;

482 
uöt64_t
 
œ°
 = 0;

483 
fd
 *
fd_cuº
 = 
cuºít
->fd[
fd_cou¡
];

485 i‡(
fd_cuº
->
node
->
ty≥
 =
DIRECTORY
) {

486 
off£t
 = -1;

487  
off£t
;

490 
fú°
 = 
fd_cuº
->
node
->first;

491 
œ°
 = 
fd_cuº
->
node
->last;

493 if(
whí˚
 =
SEEK_SET
) {

494 
fd_cuº
->
cuºít
 = 
fú°
 + 
off£t
;

495 } i‡(
whí˚
 =
SEEK_CUR
) {

496 i‡(
fd_cuº
->
cuºít
 +
off£t
 > 
œ°
) {

497 
fd_cuº
->
cuºít

œ°
;

499 
fd_cuº
->
cuºít
 +=
off£t
;

502 } i‡(
whí˚
 =
SEEK_END
) {

503 
fd_cuº
->
cuºít
 =
œ°
;

506 
off£t
 = -1;

509  
off£t
;

512 
	}
}

515 
dú
* 
	$sys_›ídú
(*
∑th
)

518 
fûe_t
 *
node
;

519 
fûe_t
 *
node_ãmp
;

520 *
«me
;

521 
dú∑th
[50];

522 
i
=0;

524 
node
 = 
roŸ
;

526 
	`°r˝y
(
dú∑th
,
∑th
);

528 
«me
 = 
	`°πok
(
dú∑th
,"/");

529 i‡(
«me
 =
NULL
)

530  (
dú
 *)
NULL
;

531 
dú
* 
ªt_dú
;

533 i‡((
	`°rcmp
(
«me
,"..") == 0) || (strcmp(name,".") == 0)){

534 
node
 = 
cuºít
->
cur_node
;

537  
«me
 !=
NULL
 ) {

538 
node_ãmp
 = 
node
;

540 i‡(
	`°rcmp
(
«me
,".") == 0 ) {

541 
node
 =Çode->
chûd
[0];

543 } i‡(
	`°rcmp
(
«me
,"..") == 0) {

544 
node
 =Çode->
chûd
[1];

547 
i
=2; i < 
node
->
œ°
 ; i++) {

549 i‡(
	`°rcmp
(
«me
,
node
->
chûd
[
i
]->name) == 0) {

550 
node
 =Çode->
chûd
[
i
];

555 i‡(
i
 =
node_ãmp
->
œ°
) {

556  (
dú
 *)
NULL
;

560 
«me
 = 
	`°πok
(
NULL
,"/");

563 i‡(
node
->
ty≥
 =
DIRECTORY
) {

564 
ªt_dú
 = (
dú
 *)
	`kmÆloc
();

565 
ªt_dú
->
cuºít
 = 2;

566 
ªt_dú
->
node
 =Çode;

567  
ªt_dú
;

569  (
dú
 *)
NULL
;

571 
	}
}

573 *
	$¥öt_node
(
fûe_t
 *
p_node
)

576 
node_buf
[10][30];

578 
ödex
 = 0;

579 
buf_i
 = 0;

580 *
°r
 = 
buf„r
;

581 
	`bzîo
(
node_buf
,300);

583 
fûe_t
 *
node
 = 
p_node
;

584 i‡(
node
 =
NULL
)

585  (*)
NULL
;

586 
node
 !
roŸ
) {

587 
	`°r˝y
(
node_buf
[
ödex
],
node
->
«me
);

588 
ödex
++;

589 
node
 =Çode->
chûd
[1];

592 
ödex
 >=0)

594  
node_buf
[
ödex
][
buf_i
] != '\0')

596 *
°r
 = 
node_buf
[
ödex
][
buf_i
];

597 
buf_i
++;

598 
°r
++;

601 
buf_i
 = 0;

602 
ödex
--;

603 i‡(
ödex
 >= 0)

604 *
°r
++ = '/';

606 
°r
++;

607 *
°r
 = '\0';

609  
buf„r
;

610 
	}
}

612 
	$sys_chdú
(*
∑th
)

614 
√w∑th
[30];

615 
	`°r˝y
(
√w∑th
,
∑th
);

616 
dú
 *
√wdú
 = 
	`sys_›ídú
(
∑th
);

617 i‡(
√wdú
 =
NULL
)

619 i‡(
√wdú
->
node
 =
NULL
)

622 
	`°r˝y
(
cuºít
->
cur_dú
, 
	`¥öt_node
(
√wdú
->
node
));

625 
	}
}

628 
uöt64_t
 
	$sys_gëdíts
(
uöt64_t
 
fd_no
,uöt64_à
buf
,uöt64_à
cou¡
)

630 
díåy
 *
dú
 ;

631 
dú
 = (
díåy
 *)
buf
;

632 
dú
->
öode_no
 = 
cuºít
->
fd
[
fd_no
]->inode_no;

633 
	`°r˝y
(
dú
->
«me
,
cuºít
->
fd
[
fd_no
]->
node
->name);

635  (
uöt64_t
)
dú
;

636 
	}
}

639 
díåy
* 
	$sys_ªaddú
(
dú
* dir)

641 i‡((
dú
->
cuºít
 > 0Ë&& (dú->
node
->
œ°
 >= 3) && (dir->current < dir->node->last))

643 
	`°r˝y
(
dú
->
cuºít_díåy
.
«me
,dú->
node
->
chûd
[dú->
cuºít
]->name);

644 
dú
->
cuºít
++;

645  &
dú
->
cuºít_díåy
;

647  
NULL
;

651 
	}
}

654 
	$sys_˛o£dú
(
dú
* 
íåy
)

657 i‡(
íåy
->
cuºít
 <= 1)

660 i‡(
íåy
->
node
->
ty≥
 =
DIRECTORY
 ) {

662 
íåy
->
node
 =(
fûe_t
 *)
NULL
;

663 
íåy
->
cuºít
 = 0;

670 
	}
}

672 
	$sys_kûÕro˚ss
(
pid
){

675 
	`exô
(0);

677 
	}
}

679 
	$sys_li°fûes
(*
∑th
,
pùe
)

681 
a
[100] = { 0 };

682 
	`°r˝y
(
a
,
∑th
);

683 
dú
 *
c
 = 
	`sys_›ídú
(
a
);

684 
díåy
 *
buf
;

685 
Êag
 = 
pùe
;

686 *
ch
 = 
pùe_buf„r
;

688 i‡(
pùe
 =
RD_PIPE
){

689 
	`¥ötf
("%†\n",
pùe_buf„r
);

690 } i‡(
pùe
 =
WR_PIPE
){

691 
	`bzîo
(
pùe_buf„r
,4090);

694 (
buf
 = 
	`sys_ªaddú
(
c
)Ë!
NULL
)

695 { i‡(
Êag
 =
WR_PIPE
){

696 
	`°r˝y
(
ch
,
buf
->
«me
);

697 
ch
 = ch + 
	`°æí
(
buf
->
«me
);

698 *
ch
 = ' ';

699 
ch
++;

702 
	`¥ötf
("%s\n", 
buf
->
«me
);

709 
	}
}

711 
	$sys_ˇtfûes
(*
∑th
,
pùe
)

713 
a
[100] = {0};

714 
	`°r˝y
(
a
,
∑th
);

716 i‡(
pùe
 =
RD_PIPE
){

717 
	`¥ötf
(" \¿%†\n",
pùe_buf„r
);

718 } i‡(
pùe
 =
WR_PIPE
 ||Öùê=
NO_PIPE
){

719 
	`bzîo
(
pùe_buf„r
,4090);

720 
fd1
;

721 
fd1
 = 
	`sys_›í
(
a
,
O_RDWR
);

722 i‡(
fd1
 != -1)

723 
	`sys_ªad
((
uöt64_t
)
fd1
,(uöt64_t)
pùe_buf„r
,4096);

725 
	`¥ötf
("incorrect fileÇame \n ");

728 i‡(
pùe
 =
NO_PIPE
)

729 
	`¥ötf
("%†\n",
pùe_buf„r
);

732 
	}
}

734 
	$sys_echofûes
(*
∑th
,
pùe
)

740 i‡(
pùe
 =
RD_PIPE
){

741 
	`¥ötf
("ÑódÖùê%†\n",
pùe_buf„r
);

742 } i‡(
pùe
 =
WR_PIPE
 ||Öùê=
NO_PIPE
){

743 
	`bzîo
(
pùe_buf„r
,4090);

744 
	`°r˝y
(
pùe_buf„r
,
∑th
);

745 i‡(
pùe
 =
NO_PIPE
)

746 
	`¥ötf
("\¿%†\n",
pùe_buf„r
);

749 
	}
}

	@tarfs.c

1 
	~<sys/vmmu.h
>

2 
	~<sys/pm≠.h
>

3 
	~<sys/°rög.h
>

4 
	~<sys/dúít.h
>

5 
	~<sys/èrfs.h
>

6 
	~<sys/sbunix.h
>

8 
uöt64_t
 
	$powî
 (
uöt64_t
 
x
, 
e
) {

10 i‡(
e
 == 0)  1;

12  
x
 * 
	`powî
(x, 
e
-1);

13 
	}
}

16 
	$∑r£_èrfs
(*
∑th
,
ty≥
,
uöt64_t
 
fú°
,uöt64_à
œ°
)

18 
fûe_t
 *
node_ãmp
;

19 
fûe_t
 *
node_cuºít
;

20 
fûe_t
 *
√w_ãmp_node
;

21 *
«me
;

22 *
dú∑th
;

23 
i
=0;

26 
dú∑th
 = (*)
	`kmÆloc
();

27 
	`°r˝y
(
dú∑th
,
∑th
);

28 
node_cuºít
 = 
roŸ
->
chûd
[2];

30 
«me
 = 
	`°πok
(
dú∑th
,"/");

32 i‡(
«me
 =
NULL
)

35  
«me
 !=
NULL
 ) {

36 
node_ãmp
 = 
node_cuºít
;

38 
i
=2; i < 
node_cuºít
->
œ°
 ; i++) {

39 i‡(
	`°rcmp
(
«me
,
node_cuºít
->
chûd
[
i
]->name) == 0) {

40 
node_cuºít
 = (
fûe_t
 *Íode_cuºít->
chûd
[
i
];

45 i‡(
i
 =
node_ãmp
->
œ°
){

46 
√w_ãmp_node
 = 
	`¸óã_node
(
«me
,
node_cuºít
,
ty≥
,
fú°
,
œ°
,0);

47 
node_cuºít
->
chûd
[node_cuºít->
œ°
] = 
√w_ãmp_node
;

48 
node_cuºít
->
œ°
 +=1;

50 
«me
 = 
	`°πok
(
NULL
,"/");

53 
	}
}

57 
	$öô_èrfs
()

59 
fûe_t
 *
node
;

61 
roŸ
 = (
fûe_t
 *)
	`kmÆloc
();

62 
roŸ
->
ty≥
 = 
DIRECTORY
;

63 
roŸ
->
fú°
 = 0;

64 
roŸ
->
œ°
 = 2;

65 
roŸ
->
cuºít
 = 0;

66 
roŸ
->
chûd
[0] =Ñoot;

67 
roŸ
->
chûd
[1] =Ñoot;

68 
roŸ
->
öode_no
 = 0;

70 
	`°r˝y
(
roŸ
->
«me
,"/");

72 
node
 = 
	`¸óã_node
("roŸfs",
roŸ
,
DIRECTORY
,0,2,0);

73 
roŸ
->
œ°
 += 1;

74 
roŸ
->
chûd
[2]=
node
;

76 
uöt64_t
 
decimÆ
;

77 
posix_hódî_u°¨
 *
hód
 = (posix_hódî_u°¨ *)&
_bö¨y_èrfs_°¨t
;

80 
uöt32_t
 *
íd
 = (uöt32_à*)
hód
;

83 *
íd
++ || *end++ || *end){

84 
j
, 
k
=0;

85 
decimÆ
=0;

86 
j
=10;j>=0;--j)

87 
decimÆ
 = decimÆ + (
hód
->
size
[
j
]-48Ë* 
	`powî
(8,
k
++);

88 if(
decimÆ
%512!=0){

89 
decimÆ
=(decimal/512)*512;

90 
decimÆ
+=512;

93 i‡(
	`°rcmp
(
hód
->
ty≥Êag
,"5") == 0){

94 
	`∑r£_èrfs
(
hód
->
«me
,
DIRECTORY
,0,2);

96 
	`∑r£_èrfs
(
hód
->
«me
,
FILE
,(
uöt64_t
)(hód+1),(uöt64_t)((*)hód + 
decimÆ
 + (
posix_hódî_u°¨
)));

101 
hód
 = (
posix_hódî_u°¨
 *)((
uöt64_t
)hód + 
decimÆ
 + (posix_header_ustar));

102 
íd
 = (
uöt32_t
 *)
hód
;

107 
	}
}

110 
fûe_t
* 
	$¸óã_node
(*
«me
,
fûe_t
 *
∑ª¡_node
,
uöt64_t
 
ty≥
,uöt64_à
fú°
,uöt64_à
œ°
,uöt64_à
öode_no
)

112 
fûe_t
 *
√w_node
 = (fûe_à*)
	`kmÆloc
();

113 
√w_node
->
ty≥
 =Åype;

114 
√w_node
->
fú°
 = first;

115 
√w_node
->
œ°
 =last;

116 
√w_node
->
cuºít
 = 
fú°
;

118 
√w_node
->
chûd
[0] =Çew_node;

119 
√w_node
->
chûd
[1] = 
∑ª¡_node
;

121 
	`°r˝y
(
√w_node
->
«me
,name);

122 
√w_node
->
öode_no
 = inode_no;

124  
√w_node
;

126 
	}
}

	@timer.c

8 
	~<sys/defs.h
>

9 
	~<sys/sbunix.h
>

10 
	~<sys/öãºu±s.h
>

11 
	~<sys/¥o˚ss.h
>

18 
	gtimî_ticks
 = 0;

20 
	$tick_timî
(
i§_ªgs
 *
r
)

22 
uöt32_t
 
hrs
 = 0, 
mös
 = 0, 
£cs
 = 0;

23 
uöt32_t
 
time_ãmp
 = 0;

26 
timî_ticks
++;

27 
	`de¸emít_¶ìp_time
();

33 if((
timî_ticks
 % 18) == 0) {

35 
	`de¸emít_¶ìp_time
();

37 
	`scheduÀ
();

40 
hrs
 = (
timî_ticks
/100)/3600;

42 
time_ãmp
 = (
timî_ticks
/100)%3600;

43 
mös
 = 
time_ãmp
/60;

44 
£cs
 = 
time_ãmp
%60;

46 if(
£cs
 == 60)

47 
£cs
 = 0;

48 
	`¥öt_löe
(36, 24, " ");

49 
	`¥öt_löe
(36, 24, "%d:%d:%d", 
hrs
, 
mös
, 
£cs
);

53 
	}
}

54 
	$ö°Æl_timî
()

57 
uöt16_t
 
TIMER_‰equícy
 = 1193180/100;

60 
	`outb
(0x43,0x36);

63 
	`outb
(0x40, (
uöt16_t
)(
TIMER_‰equícy
 & 0xFF));

66 
	`outb
(0x40, (
uöt16_t
)(
TIMER_‰equícy
 >> 8));

68 
	}
}

	@vmmu.c

9 
	~<sys/defs.h
>

10 
	~<sys/sbunix.h
>

11 
	~<sys/pm≠.h
>

12 
	~<sys/vmmu.h
>

13 
	~<sys/°rög.h
>

16 
kînmem
;

17 
uöt64_t
 *
mm≠
;

19 
PML4
 *
	gpml4
;

20 
uöt64_t
 
	g¸3
;

21 
uöt64_t
 
	gt›_vAddr
 = 
IDEN_V
;

25 
uöt64_t
 
	$gë_addªss
(
uöt64_t
* 
íåy
)

27  (*
íåy
 & 
FRAME
);

28 
	}
}

31 
	$lﬂd_CR3
() {

33 
uöt64_t
 
ba£_pgdú_addr
 = (uöt64_t)
¸3
;

34 
__asm
 vﬁ©ûe("movq %0, %%¸3":: "b"(
ba£_pgdú_addr
));

35 
	}
}

38 
uöt64_t
 
	$gë_CR3
()

40 
uöt64_t
 
ßved_¸3
;

41 
__asm
 vﬁ©ûe("mov %%¸3, %0" : "Ù" (
ßved_¸3
));

43  
ßved_¸3
;

44 
	}
}

46 
	$£t_CR3
(
PML4
 *
√w_¸3
)

48 
uöt64_t
 
ba£_pgdú_addr
 = (uöt64_t)
√w_¸3
;

49 
__asm
 vﬁ©ûe("mov %0, %%¸3":: "b"(
ba£_pgdú_addr
));

50 
	}
}

53 * 
	$pd±_Æloc
(
PML4
 *
pml4
, 
uöt64_t
 
pml4_ödx
)

55 
PDPT
 *
pd±
 = (PDPT *)
	`Æloˇã_∑ge
();

56 
uöt64_t
 
pd±_íåy
 = (uöt64_t)
pd±
;

57 
pd±_íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

58 
pml4
->
pgèbÀ_íåõs
[
pml4_ödx
] = 
pd±_íåy
;

60  (*)
pd±
;

61 
	}
}

64 * 
	$pdt_Æloc
(
PDPT
 *
pd±
, 
uöt64_t
 
pd±_ödx
)

66 
PDT
 *
pdt
 = (PDT*)
	`Æloˇã_∑ge
();

67 
uöt64_t
 
pdt_íåy
 = (uöt64_t)
pdt
;

68 
pdt_íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

69 
pd±
->
pgèbÀ_íåõs
[
pd±_ödx
] = 
pdt_íåy
;

71  (*)
pdt
;

72 
	}
}

75 * 
	$±_Æloc
(
PDT
 *
pdt
, 
uöt64_t
 
pdt_ödx
)

77 
PT
 *
±
 = (PT *)
	`Æloˇã_∑ge
();

78 
uöt64_t
 
±_íåy
 = (uöt64_t)
±
;

79 
±_íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

80 
pdt
->
pgèbÀ_íåõs
[
pdt_ödx
] = 
±_íåy
;

82  (*)
±
;

83 
	}
}

85 
	$£tup_∑ge_èbÀs
(
uöt64_t
 
ba£
) {

86 
PDPT
 *
pd±
;

87 
PDT
 *
pdt
;

88 
PT
 *
±
;

89 
uöt64_t
 
vAddªss
 = (uöt64_t)&
kînmem
;

90 
uöt64_t
 
phys‰ì
 = 
	`gë_phys‰ì
();

91 
uöt64_t
 
physba£
 = 
ba£
;

93 
uöt64_t
 
pml4_ödx
 = 
	`PML4_INDEX
((uöt64_t)
vAddªss
);

94 
uöt64_t
 
pd±_ödx
 = 
	`PDPT_INDEX
((uöt64_t)
vAddªss
);

95 
uöt64_t
 
pdt_ödx
 = 
	`PDT_INDEX
((uöt64_t)
vAddªss
);

97 
pml4
 = (
PML4
 *)
	`Æloˇã_∑ge
();

98 
¸3
 = (
uöt64_t
)
pml4
;

99 if(!
pml4
)

102 
pd±
 = 
	`pd±_Æloc
(
pml4
, 
pml4_ödx
);

103 if(!
pd±
)

106 
pdt
 = 
	`pdt_Æloc
(
pd±
, 
pd±_ödx
);

107 if(!
pdt
)

110 
±
 = 
	`±_Æloc
(
pdt
, 
pdt_ödx
);

111 if(!
±
)

115 ; 
physba£
<
phys‰ì
 ;Öhysba£ +0x1000, 
vAddªss
 += 0x1000) {

117 
uöt64_t
 
±_ödx
 = 
	`PT_INDEX
((uöt64_t)
vAddªss
);

118 
uöt64_t
 
íåy
 = 
physba£
;

119 
íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

120 
±
->
pgèbÀ_íåõs
[
±_ödx
] = 
íåy
;

123 
	}
}

126 
	$m≠_vút_phys_addr
(

127 
uöt64_t
 
vaddr
,

128 
uöt64_t
 
∑ddr
)

130 
PDPT
 *
pd±
;

131 
PDT
 *
pdt
;

132 
PT
 *
±
;

134 
uöt64_t
 
pml4_ödx
 = 
	`PML4_INDEX
((uöt64_t)
vaddr
);

135 
uöt64_t
 
pd±_ödx
 = 
	`PDPT_INDEX
((uöt64_t)
vaddr
);

136 
uöt64_t
 
pdt_ödx
 = 
	`PDT_INDEX
((uöt64_t)
vaddr
);

137 
uöt64_t
 
±_ödx
 = 
	`PT_INDEX
((uöt64_t)
vaddr
);

139 
uöt64_t
 
pml4_íåy
 = 
pml4
->
pgèbÀ_íåõs
[
pml4_ödx
];

140 if(
pml4_íåy
 & 
PTE_P
)

141 
pd±
 = (
PDPT
 *)
	`gë_addªss
(&
pml4_íåy
);

143 
pd±
 = (
PDPT
*)
	`pd±_Æloc
(
pml4
, 
pml4_ödx
);

145 
uöt64_t
 
pd±_íåy
 = 
pd±
->
pgèbÀ_íåõs
[
pd±_ödx
];

146 if(
pd±_íåy
 & 
PTE_P
)

147 
pdt
 = (
PDT
*)
	`gë_addªss
(&
pd±_íåy
);

149 
pdt
 = (
PDT
*)
	`pdt_Æloc
(
pd±
, 
pd±_ödx
);

151 
uöt64_t
 
pdt_íåy
 = 
pdt
->
pgèbÀ_íåõs
[
pdt_ödx
];

152 if(
pdt_íåy
 & 
PTE_P
)

153 
±
 = (
PT
*)
	`gë_addªss
(&
pdt_íåy
);

155 
±
 = (
PT
*)
	`±_Æloc
(
pdt
, 
pdt_ödx
);

157 
uöt64_t
 
íåy
 = 
∑ddr
;

158 
íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

159 
±
->
pgèbÀ_íåõs
[
±_ödx
] = 
íåy
;

161 
	}
}

164 
	$£t_idítôy_∑gög
() {

166 
uöt64_t
 
vaddr
 = 
IDEN_V
;

167 
uöt64_t
 
∑ddr
 = 
IDEN_P
;

168 
uöt64_t
 
max_phys
 = 
	`gë_maxphys‰ì
();

170 ; 
∑ddr
 <
max_phys
;Öadd∏+
PAGE_SIZE
, 
vaddr
 += PAGE_SIZE){

171 
	`m≠_vút_phys_addr
(
vaddr
, 
∑ddr
);

175 
	`m≠_vút_phys_addr
((
uöt64_t
)0xffffffff800b8000UL, 
VIDEO_MEMORY
);

178 
mm≠
 = (
uöt64_t
*)(0xFFFFFFFF80000000UL | (uint64_t) mmap);

179 
	}
}

182 
uöt64_t
 
	$gë_pml4_íåy
(
PML4
 **
pml4
, 
uöt64_t
 
pml4_ödx
)

184 *
pml4
 = (
PML4
 *)((
uöt64_t
)*pml4 | 
IDEN_V
);

185 
uöt64_t
 
pml4_íåy
 = (*
pml4
)->
pgèbÀ_íåõs
[
pml4_ödx
];

187  
pml4_íåy
;

188 
	}
}

191 
uöt64_t
 
	$gë_pd±_íåy
(
PDPT
** 
pd±
, 
uöt64_t
 
pd±_ödx
)

193 *
pd±
 = (
PDPT
 *)((
uöt64_t
)*pd± | 
IDEN_V
);

194 
uöt64_t
 
pd±_íåy
 = (*
pd±
)->
pgèbÀ_íåõs
[
pd±_ödx
];

196  
pd±_íåy
;

197 
	}
}

200 
uöt64_t
 
	$gë_pdt_íåy
(
PDT
 **
pdt
, 
uöt64_t
 
pdt_ödx
)

202 *
pdt
 = (
PDT
 *Ë((
uöt64_t
Ë*pdà| 
IDEN_V
);

203 
uöt64_t
 
pdt_íåy
 = (*
pdt
)->
pgèbÀ_íåõs
[
pdt_ödx
];

205  
pdt_íåy
;

206 
	}
}

209 
uöt64_t
 
	$gë_±_íåy
(
PT
 **
±
, 
uöt64_t
 
±_ödx
)

211 *
±
 = (
PT
 *)((
uöt64_t
Ë*± | 
IDEN_V
);

212 
uöt64_t
 
±_íåy
 = (*
±
)->
pgèbÀ_íåõs
[
±_ödx
];

214  
±_íåy
;

215 
	}
}

222 
	$m≠_¥o˚ss
(

223 
uöt64_t
 
vaddr
,

224 
uöt64_t
 
∑ddr
)

226 
PDPT
 *
pd±
;

227 
PDT
 *
pdt
;

228 
PT
 *
±
;

230 
uöt64_t
 
pml4_ödx
 = 
	`PML4_INDEX
((uöt64_t)
vaddr
);

231 
uöt64_t
 
pd±_ödx
 = 
	`PDPT_INDEX
((uöt64_t)
vaddr
);

232 
uöt64_t
 
pdt_ödx
 = 
	`PDT_INDEX
((uöt64_t)
vaddr
);

233 
uöt64_t
 
±_ödx
 = 
	`PT_INDEX
((uöt64_t)
vaddr
);

235 
PML4
 *
pml4
 = (PML4*Ë
	`gë_CR3
();

237 
pml4
 = (
PML4
*Ë(
IDEN_V
 | (
uöt64_t
)Öml4);

238 
uöt64_t
 
pml4_íåy
 = 
pml4
->
pgèbÀ_íåõs
[
pml4_ödx
];

240 if(
pml4_íåy
 & 
PTE_P
)

241 
pd±
 = (
PDPT
 *)
	`gë_addªss
(&
pml4_íåy
);

243 
pd±
 = (
PDPT
*)
	`pd±_Æloc
(
pml4
, 
pml4_ödx
);

246 
uöt64_t
 
pd±_íåy
 = 
	`gë_pd±_íåy
(&
pd±
, 
pd±_ödx
);

247 if(
pd±_íåy
 & 
PTE_P
)

248 
pdt
 = (
PDT
*)
	`gë_addªss
(&
pd±_íåy
);

250 
pdt
 = (
PDT
*)
	`pdt_Æloc
(
pd±
, 
pd±_ödx
);

253 
uöt64_t
 
pdt_íåy
 = 
	`gë_pdt_íåy
(&
pdt
, 
pdt_ödx
);

254 if(
pdt_íåy
 & 
PTE_P
)

255 
±
 = (
PT
*)
	`gë_addªss
(&
pdt_íåy
);

257 
±
 = (
PT
*)
	`±_Æloc
(
pdt
, 
pdt_ödx
);

260 
±
 = (
PT
*)((
uöt64_t
Ë± | 
IDEN_V
);

261 
uöt64_t
 
íåy
 = 
∑ddr
;

262 
íåy
 |(
PTE_P
|
PTE_W
|
PTE_U
);

264 
±
->
pgèbÀ_íåõs
[
±_ödx
] = 
íåy
;

266 
	}
}

269 * 
	$kmÆloc
()

271 
uöt64_t
 
∑ge
 = (uöt64_t)
	`Æloˇã_∑ge
();

272 
PML4
 *
√wPML4
 = (PML4 *)
	`gë_CR3
();

274 
pml4
 = 
√wPML4
;

277 
	`£t_CR3
(
pml4
);

279 
t›_vAddr
 += 0x1000;

280 
	`m≠_¥o˚ss
(
t›_vAddr
, 
∑ge
);

281 
	`mem£t
((*)
t›_vAddr
, 0, 4096);

284  (*)(
t›_vAddr
);

285 
	}
}

288 * 
	$£t_u£r_AddrS∑˚
()

290 
PML4
 *
√wPML4
 = (PML4 *)
	`Æloˇã_∑ge
();

291 
PML4
 *
curPML4
 = (PML4 *)
	`gë_CR3
();

293 
curPML4
 = (
PML4
 *)((
uöt64_t
)curPML4 | 
IDEN_V
);

296 ((
PML4
 *)((
uöt64_t
)
√wPML4
 | 
IDEN_V
))->
pgèbÀ_íåõs
[511]

297 
curPML4
->
pgèbÀ_íåõs
[511];

299  (*)
√wPML4
;

300 
	}
}

303 
	$£tup_chûd_∑gëabÀ
(
uöt64_t
 
chûd_PML4
)

305 
PML4
 *
c_pml4
 = (PML4 *)
chûd_PML4
;

306 
PML4
 *
p_pml4
 = (PML4 *)
	`gë_CR3
();

308 
pml4_ödx
 = 0;

309 ; 
pml4_ödx
 < 510;Öml4_indx++) {

311 
uöt64_t
 
pml4_íåy
 = 
	`gë_pml4_íåy
(&
p_pml4
, 
pml4_ödx
);

313 if(
pml4_íåy
 & 
PTE_P
) {

315 
PML4
 *
tmp_pml4
 = (PML4 *)((
uöt64_t
)
c_pml4
 | 
IDEN_V
);

316 
PDPT
 *
c_pd±
 = (PDPT *)
	`pd±_Æloc
(
tmp_pml4
, 
pml4_ödx
);

318 
PDPT
 *
p_pd±
 = (PDPT *Ë
	`gë_addªss
(&
pml4_íåy
);

319 
pd±_ödx
 = 0;

320 ; 
pd±_ödx
 < 512;Ödpt_indx++) {

322 
uöt64_t
 
pd±_íåy
 = 
	`gë_pd±_íåy
(&
p_pd±
, 
pd±_ödx
);

323 if(
pd±_íåy
 & 
PTE_P
) {

325 
PDPT
 *
tmp_pd±
 = (PDPT *)((
uöt64_t
)
c_pd±
 | 
IDEN_V
);

326 
PDT
 *
c_pdt
 = (PDT *)
	`pdt_Æloc
(
tmp_pd±
, 
pd±_ödx
);

328 
PDT
 *
p_pdt
 = (PDT *Ë
	`gë_addªss
(&
pd±_íåy
);

329 
pdt_ödx
 = 0;

330 ; 
pdt_ödx
 < 512;Ödt_indx++) {

332 
uöt64_t
 
pdt_íåy
 = 
	`gë_pdt_íåy
(&
p_pdt
, 
pdt_ödx
);

333 if(
pdt_íåy
 & 
PTE_P
) {

335 
PDT
 *
tmp_pdt
 = (PDT *)((
uöt64_t
)
c_pdt
 | 
IDEN_V
);

336 
PT
 *
c_±
 = (PT *)
	`±_Æloc
(
tmp_pdt
, 
pdt_ödx
);

338 
PT
 *
p_±
 = (PT *)
	`gë_addªss
(&
pdt_íåy
);

339 
±_ödx
 = 0;

340 ; 
±_ödx
 < 512;Öt_indx++) {

342 
uöt64_t
 
±_íåy
 = 
	`gë_±_íåy
(&
p_±
, 
±_ödx
);

343 if(
±_íåy
 & 
PTE_P
) {

344 
uöt64_t
 
∑ge
 = (uöt64_t)
	`gë_addªss
(&
±_íåy
);

350 
±_íåy
 = 
∑ge
 | 
PTE_P
 | 
PTE_U
 | 
PTE_COW
;

352 
c_±
 = (
PT
 *)((
uöt64_t
)c_± | 
IDEN_V
);

353 
c_±
->
pgèbÀ_íåõs
[
±_ödx
] = 
±_íåy
;

356 
p_±
->
pgèbÀ_íåõs
[
±_ödx
] = 
±_íåy
;

365 ((
PML4
 *)((
uöt64_t
)
c_pml4
 | 
IDEN_V
))->
pgèbÀ_íåõs
[511] =

366 ((
PML4
 *)((
uöt64_t
)
p_pml4
))->
pgèbÀ_íåõs
[511];

368 ((
PML4
 *)((
uöt64_t
)
c_pml4
 | 
IDEN_V
))->
pgèbÀ_íåõs
[510] =

369 ((
PML4
 *)((
uöt64_t
)
p_pml4
))->
pgèbÀ_íåõs
[510];

370 
	}
}

373 
	$k‰ì
(
uöt64_t
 
vaddr
)

375 
PDPT
 *
pd±
 = 
NULL
;

376 
PDT
 *
pdt
 = 
NULL
;

377 
PT
 *
±
 = 
NULL
;

378 
uöt64_t
 
∑ddr
 = 0;

380 
uöt64_t
 
pml4_ödx
 = 
	`PML4_INDEX
((uöt64_t)
vaddr
);

381 
uöt64_t
 
pd±_ödx
 = 
	`PDPT_INDEX
((uöt64_t)
vaddr
);

382 
uöt64_t
 
pdt_ödx
 = 
	`PDT_INDEX
((uöt64_t)
vaddr
);

383 
uöt64_t
 
±_ödx
 = 
	`PT_INDEX
((uöt64_t)
vaddr
);

385 
PML4
 *
pml4
 = (PML4 *Ë
	`gë_CR3
();

386 
uöt64_t
 
pml4_íåy
 = 
	`gë_pml4_íåy
(&
pml4
, 
pml4_ödx
);

388 if(
pml4_íåy
 & 
PTE_P
)

389 
pd±
 = (
PDPT
 *)
	`gë_addªss
(&
pml4_íåy
);

391 
uöt64_t
 
pd±_íåy
 = 
	`gë_pd±_íåy
(&
pd±
, 
pd±_ödx
);

392 if(
pd±_íåy
 & 
PTE_P
)

393 
pdt
 = (
PDT
 *)
	`gë_addªss
(&
pd±_íåy
);

395 
uöt64_t
 
pdt_íåy
 = 
	`gë_pdt_íåy
(&
pdt
, 
pdt_ödx
);

396 if(
pdt_íåy
 & 
PTE_P
)

397 
±
 = (
PT
 *)
	`gë_addªss
(&
pdt_íåy
);

399 if(
±
 !
NULL
){

400 
∑ddr
 = 
	`gë_±_íåy
(&
±
, 
±_ödx
);

401 
	`dóŒoˇã_∑ge
((*)
∑ddr
);

403 
	}
}

406 * 
	$gë_phy_addr
(
uöt64_t
 
vaddr
)

408 
uöt64_t
 
∑ge
 = (uöt64_t)
	`Æloˇã_∑ge
();

409 
	`m≠_¥o˚ss
(
vaddr
, 
∑ge
);

410  (*)
vaddr
;

411 
	}
}

414 
	$dñëe_∑gëabÀ
(
uöt64_t
 
pml4
)

416 
PML4
 *
d_pml4
 = (PML4 *)
pml4
;

417 
pml4_ödx
 = 0;

418 ; 
pml4_ödx
 < 510;Öml4_indx++) {

420 
uöt64_t
 
pml4_íåy
 = 
	`gë_pml4_íåy
(&
d_pml4
, 
pml4_ödx
);

422 if(
pml4_íåy
 & 
PTE_P
) {

424 
PDPT
 *
d_pd±
 = (PDPT *Ë
	`gë_addªss
(&
pml4_íåy
);

425 
pd±_ödx
 = 0;

426 ; 
pd±_ödx
 < 512;Ödpt_indx++) {

428 
uöt64_t
 
pd±_íåy
 = 
	`gë_pd±_íåy
(&
d_pd±
, 
pd±_ödx
);

429 if(
pd±_íåy
 & 
PTE_P
) {

431 
PDT
 *
d_pdt
 = (PDT *Ë
	`gë_addªss
(&
pd±_íåy
);

432 
pdt_ödx
 = 0;

433 ; 
pdt_ödx
 < 512;Ödt_indx++) {

435 
uöt64_t
 
pdt_íåy
 = 
	`gë_pdt_íåy
(&
d_pdt
, 
pdt_ödx
);

436 if(
pdt_íåy
 & 
PTE_P
) {

438 
PT
 *
d_±
 = (PT *)
	`gë_addªss
(&
pdt_íåy
);

439 
±_ödx
 = 0;

440 ; 
±_ödx
 < 512;Öt_indx++) {

442 
uöt64_t
 
±_íåy
 = 
	`gë_±_íåy
(&
d_±
, 
±_ödx
);

443 if(
±_íåy
 & 
PTE_P
) {

444 
uöt64_t
 
∑ge
 = (uöt64_t)
	`gë_addªss
(&
±_íåy
);

445 
	`dóŒoˇã_∑ge
((*)
∑ge
);

448 
	`k‰ì
((
uöt64_t
)
d_±
);

451 
	`k‰ì
((
uöt64_t
)
d_pdt
);

454 
	`k‰ì
((
uöt64_t
)
d_pd±
);

457 
	}
}

463 
uöt64_t
 
	$∑
(
uöt64_t
 
vaddr
)

465 
uöt64_t
 
∑ddr
 = 0;

466 
PDPT
 *
pd±
 = 
NULL
;

467 
PDT
 *
pdt
 = 
NULL
;

468 
PT
 *
±
 = 
NULL
;

470 
uöt64_t
 
pml4_ödx
 = 
	`PML4_INDEX
((uöt64_t)
vaddr
);

471 
uöt64_t
 
pd±_ödx
 = 
	`PDPT_INDEX
((uöt64_t)
vaddr
);

472 
uöt64_t
 
pdt_ödx
 = 
	`PDT_INDEX
((uöt64_t)
vaddr
);

473 
uöt64_t
 
±_ödx
 = 
	`PT_INDEX
((uöt64_t)
vaddr
);

475 
PML4
 *
pml4
 = (PML4*Ë
	`gë_CR3
();

476 
pml4
 = (
PML4
*Ë(
IDEN_V
 | (
uöt64_t
)Öml4);

477 
uöt64_t
 
pml4_íåy
 = 
pml4
->
pgèbÀ_íåõs
[
pml4_ödx
];

479 if(
pml4_íåy
 & 
PTE_P
)

480 
pd±
 = (
PDPT
 *)
	`gë_addªss
(&
pml4_íåy
);

482 
uöt64_t
 
pd±_íåy
 = 
	`gë_pd±_íåy
(&
pd±
, 
pd±_ödx
);

483 if(
pd±_íåy
 & 
PTE_P
)

484 
pdt
 = (
PDT
*)
	`gë_addªss
(&
pd±_íåy
);

487 
uöt64_t
 
pdt_íåy
 = 
	`gë_pdt_íåy
(&
pdt
, 
pdt_ödx
);

488 if(
pdt_íåy
 & 
PTE_P
)

489 
±
 = (
PT
*)
	`gë_addªss
(&
pdt_íåy
);

492 if(
±
 !
NULL
)

493 
∑ddr
 = 
	`gë_±_íåy
(&
±
, 
±_ödx
);

495  
∑ddr
;

496 
	}
}

	@
1
.
0
14
108
elf.c
gdt.c
io.c
isr.c
keyboard.c
main.c
pmap.c
print.c
process.c
string.c
syscall.c
tarfs.c
timer.c
vmmu.c
